### 背景

一个数据包，它在本地生产，一次生产一个，有一定体量。

用localId进行标识，记录在本地。

当有网情况下，会把本地localId替换成云端Id，并且把文件具体数据进行上传。

### 数据包组成

#### **本地id：**

作用：用来在本地标识数据，因为数据支持无网生成。

数据格式：local+时间戳

产生时机：创建数据包时产生

#### 云端Id：

作用：用来在云端表示数据

产生时机：和服务交互时产生

### 基本信息数据

作用：记录包的基本信息，比如标题，创建人，修改时间等信息。

产生时机：创建数据，编辑数据的时候。

#### **元数据：**

作用：记录数据包切片的上传状态，未上传图片的信息。

产生时机：创建数据包时初始化，产生新切片时会更新，添加新图片也会更新。

#### 图片数据：

作用：记录数据包的图片信息。

产生时机：用户手动添加。

因为图片的数据比较大，所以需要异步上传。

#### 文件具体数据：

作用：记录数据包的具体数据。

产生时机：

- 在本地记录数据时持续产生，会持续记录到内存中。
  - 记录到文件时机：当记录时间或者记录数据的大小达到一定量级。
- 因为支持离线查看，所以当拉取云端数据，且云端id对应的mapid不存在的时候，会把云端的数据备份到本地。

上传给服务时机：需要上传服务，有网时进行上传，上传时机在下面记录。

### 缓存

#### 本地id缓存

读取值：

做法：当读取值的时候，如果缓存存在优先读缓存。缓存不存在则读文件，并用文件去设置缓存。

目的：读取缓存减少io操作，速度快。

更新值：

- 新增，分三种情况。

  - 当缓存和本地文件同时存在。两个都更新。
  - 当缓存不存在，更新本地文件，并把缓存设置为更新后的本地文件的值。
  - 当缓存和本地文件都不存在，同时更新。

    总结：当进行写操作的时候，必须保证文件和缓存都是最新的
- 删除

#### 元数据缓存

读取和更新的机制参考本地ID。

#### 图片数据缓存

超出上限

新增数据时数据超过存储上限怎么办。

- 删除对应类型（创建或者收藏）最老的一个localId
- 删除localId对应的目录（一个目录包含1～n个文件，每个文件是一个切片）

### 文件

#### 本地id文件

类型：单个文件

本地id：local+时间戳，创建文件时产生

数据格式：{

    [本地id]：云端id

}

#### 元数据文件

类型：单个文件，在元数据目录下，用本地id作为文件标识。

数据格式：

- 分片上传的状态，未上传，上传中，已上传。
- id下未上传的图片路径

#### 基本信息文件

类型：单个文件，在基本信息目录下，用本地id作为文件标识。

数据格式：文件的基本信息，标题，修改时间等。

### 图片信息文件

类型：单个文件，在图片信息目录下，用本地id作为文件表示。

用来存储图片的地址

#### 文件具体信息目录

类型：单个目录，以localId命名文件目录。

##### 切片文件

类型：一个目录内的多个切片文件，

目录下存储切片文件。

##### 图片

未上传的本地文件存在这个目录下

**脏队列缓存**

清除时机：进行单个文件或者多个文件上传的时候

**读取的文件目录**

本地id文件

### 数据的增删改查

#### 数据生产流程

##### 初始化数据

- 生成localId
- 初始化元数据
- 存储localId到映射中
- 异步生成云端id，更新映射（离线场景存在更新失败的情况）

以下步骤支持同时触发

##### 编辑元数据

数据来源：用户输入

用户可以编辑元数据的信息，包含标题等独立于文件详情数据的一些数据。

##### 保存具体切片数据

数据来源：通过调用上游提供的监听事件获得数据

保存形式：文件切片

每个切片大小：128kb

保存方式：

- 从元数据中获取文件切片长度
- 根据localId获取文件目录
- 打开文件目录最新的一个文件
  - 当最新的文件不存在，创建一个新的文件，写入数据，更新元信息对应的切片状态为未上传
  - 当最新的文件存在
    - 文件大小大于等于阈值，创建一个新的文件，写入数据，更新元信息对应的切片状态为未上传
    - 文件大小小于阈值，写入文件
      - 写入成功，更新元信息对应的切片状态为未上传
      - 写入失败

#### 数据删除流程

- 有网
  - 是云端id，先删远程数据，删除成功之后再删本地数据。
  - 是本地id，删除本地数据
- 无网
  - 删除本地数据

#### 数据增量更新

只有基本数据，如标题，修改时间等可以进行增量更新。

当数据一部分上传给服务，在其他设备就支持显示了。

此刻其他用户可修改标题等基本信息。

举个例子：假设用户a生产了数据，此刻用户b修改了数据。

那么用户a再拉取数据的时候，就需要对基本数据部分进行增量更新。

#### 数据展示流程

##### 数据包列表

在进入数据包yi z z列表时，先检测网络状况。

- 有网络，和服务请求数据，把服务请求的数据和本地的数据进行合并。本地的在前服务的在后。
- 无网，那就只展示本地的数据，这样能保证用户在离线状态下依然可以使用。

##### 数据包信息

在展示数据包信息时。

- 有网络，和服务请求数据，把服务请求的数据和本地的数据进行合并。优先以本地的数据为准。
  - 当服务的图片被判违规时就使用服务的图片数据。
- 无网，那就只展示本地的数据，这样能保证用户在离线状态下依然可以使用。

对于元数据：展示的是最新的

对于详情数据：会展示拼接完成后的。

#### 数据上传流程

获取本地的未上传数据。

**上传单一数据**

上传时机：

**上传多数据**

做法：

清除脏队列缓存

问题：

#### 本地存储数据包

- 编辑
- 增量
- 收藏
  收藏的时候会设置localId

### **优化点**

1. **切片上传，用promise.all代替await的promise队列，每个切片都有标识，所以不存在乱序的现象。**
2. **上传的时候可以用promise.race替代promise.all：有一个成功就可以进行上传**

### **知识点**

#### **文件的切片上传**

端会告诉服务，有几片，然后把具有标识的片上传给服务。重复上传相同的片会发生覆盖，当服务接收到完整的片之后会进行拼接，拼接之后再下发。

##### **如何上传**

##### **如何确定标识**
