# **é¡¹ç›®èƒŒæ™¯**

è´Ÿè´£bdwk PPTåœ¨çº¿ç¼–è¾‘å™¨ç¼©ç•¥å›¾SDKçš„å®ç°ä¸æ€§èƒ½ä¼˜åŒ–ã€‚

# **æ•´ä½“æ¶æ„è®¾è®¡**

**æ ¸å¿ƒæ•°æ®ç»“æ„**

ç¼©ç•¥å›¾æ•°æ®æ¨¡å‹ - å…³é”®è®¾è®¡äº®ç‚¹

```javascript
thumbnailList: Array<{
  img: string; // Blob URL - å†…å­˜ä¼˜åŒ–å…³é”®
  id: number; // ä¸ç´¢å¼•åŒæ­¥ï¼Œç¡®ä¿ä¸€è‡´æ€§
  slideRatio: number; // å®½é«˜æ¯”ï¼Œç”¨äºæ­£ç¡®æ˜¾ç¤º
  dirty: boolean; // è„æ ‡è®° - æ›´æ–°ä¼˜åŒ–å…³é”®
  slideFileName: string; // æ ‡è¯†å¹»ç¯ç‰‡æ–‡ä»¶
  slideId: string; // å”¯ä¸€æ ‡è¯†
}> = [];
```

# **æ¸²æŸ“æµç¨‹ä¼˜åŒ–**

æœ‰æ—¶ç”¨æˆ·ä¼šä¼ å…¥ä¸€ä¸ªæœ‰å¾ˆå¤šé¡µå¹»ç¯ç‰‡çš„PPTï¼Œæ­¤æ—¶å¦‚æœä¸€æ¬¡æ€§æ¸²æŸ“ä¼šé€ æˆå¾ˆå¤§çš„æ€§èƒ½æ¶ˆè€—ã€‚å› æ­¤æœ‰ä¸€ä¸ª**å¤šçº§æ¸²æŸ“ä¼˜åŒ–**çš„ç­–ç•¥ã€‚

## **1. æ‰¹é‡åŠ è½½ï¼ˆåˆå§‹åŒ–ï¼‰**

åˆå§‹åŒ–æ—¶ï¼Œåªä¼šæ¸²æŸ“å‰åå¼ å¹»ç¯ç‰‡ã€‚èµ°çš„æ˜¯æ‰¹é‡æ›´æ–°çš„é€»è¾‘ã€‚

## **2. è§†å£å†…ç¼©ç•¥å›¾æ›´æ–°**

æ ¹æ®å‚æ•°æœ‰ä¸¤ä¸ªåˆ†æ”¯ï¼š

* è§†å£å†…æ»šåŠ¨åŠ è½½ç¼©ç•¥å›¾
* å½“å‰é¡µå›¾ç‰‡åŠ è½½å®Œæ¯•ï¼ˆ *è¿™ä¸ªåˆ†æ”¯åŒ…å«äº†å•é¡µç²¾å‡†æ›´æ–°çš„é€»è¾‘ï¼Œå› ä¸ºå…±ç”¨äº†è§†å£æ£€æµ‹éƒ¨åˆ†çš„ä»£ç * ï¼‰ã€‚

```javascript
/**
 * åˆ¤æ–­å…ƒç´ æ˜¯å¦åœ¨è§†å£å†…
 * @param {HTMLElement} element - ç›®æ ‡å…ƒç´ 
 * @param {HTMLElement} [container=document.documentElement] - å®¹å™¨å…ƒç´ ï¼Œé»˜è®¤ä¸ºæ ¹å…ƒç´ 
 * @return {boolean} - å…ƒç´ æ˜¯å¦åœ¨è§†å£å†…
 */
function isInViewport(element: HTMLElement, container: HTMLElement = document.documentElement) {
  const rect = element.getBoundingClientRect();
  return (
    // å…ƒç´ çš„ä¸Šè¾¹ç•Œåœ¨è§†å£ä¸Šè¾¹ç•Œä¸‹ä¾§æˆ–é‡åˆ
    rect.top >= 0 &&
    // å…ƒç´ çš„å·¦è¾¹ç•Œåœ¨è§†å£å·¦è¾¹ç•Œå³ä¾§æˆ–é‡åˆ
    rect.left >= 0 &&
    // å…ƒç´ çš„åº•è¾¹ç•Œåœ¨è§†å£åº•è¾¹ç•Œä¸Šä¾§æˆ–é‡åˆ
    // å…¼å®¹å¤„ç†ï¼šwindow.innerHeight æˆ– container.clientHeight
    // window.innerHeightï¼šæµè§ˆå™¨çª—å£çš„å®Œæ•´é«˜åº¦ï¼ˆåŒ…æ‹¬æ»šåŠ¨æ¡ï¼‰
    // document.documentElement.clientHeightï¼šè§†å£é«˜åº¦ï¼ˆä¸åŒ…æ‹¬æ»šåŠ¨æ¡ï¼‰
    // è¿™æ˜¯ä¸ºäº†å…¼å®¹åœ¨ iframe æƒ…å†µä¸‹æµè§ˆå™¨è·å–ä¸åˆ° window.innerHeight çš„ç‰¹æ®Šæƒ…å†µ
    rect.bottom <= (window.innerHeight || container.clientHeight) &&
    // å…ƒç´ çš„å³è¾¹ç•Œåœ¨è§†å£å³è¾¹ç•Œå·¦ä¾§æˆ–é‡åˆ
    // å…¼å®¹å¤„ç†ï¼šwindow.innerWidth æˆ– container.clientWidth
    rect.right <= (window.innerWidth || container.clientWidth)
  );
}

/**
 * æ¸²æŸ“è§†å£å†…çš„ç¼©ç•¥å›¾
 * @param slideInfo - å¯é€‰å‚æ•°ï¼ŒåŒ…å«å¹»ç¯ç‰‡ç´¢å¼•æˆ–ID
 */
const renderViewportThumbnails = (slideInfo?: { index?: number; slideId?: string }) => {
  if (!thumbnailListRef.value) return;
  
  // è·å–æ‰€æœ‰ç¼©ç•¥å›¾DOMå…ƒç´ 
  thumbnailsItemList = document.querySelectorAll('.thumbnails-item') as unknown as HTMLElement[];
  const range = [undefined, undefined] as Array<number | undefined>;
  
  // éå†ç¼©ç•¥å›¾DOMåˆ—è¡¨ï¼Œè·å–è§†å£å†…çš„ç¼©ç•¥å›¾DOM
  thumbnailsItemList.forEach((el, index) => {
    if (isInViewport(el as HTMLElement, thumbnailListRef.value!)) {
      if (range[0] === undefined) {
        range[0] = index;
      }
      if (range[1] === undefined) {
        range[1] = index;
      }
  
      if (index < range[0]) {
        range[0] = index;
      }
  
      if (index > range[1]) {
        range[1] = index;
      }
    }
  });
  
  // å¦‚æœä¼ å…¥äº†slideIdï¼Œindexä»¥slideIdä¸ºå‡†
  let { index, slideId } = slideInfo || {};
  
  // å› ä¸ºç¼–è¾‘å±‚æ‹¿åˆ°çš„indexçš„é¡ºåºæ¯”UIçš„indexæ›´æ–°
  if (slideId) {
    index = mainStore.editor?.canvasThumbnails?.thumbnailList.findIndex(
      (item) => item.slideId === slideId
    );
  }
  
  // ç›‘å¬å›¾ç‰‡åŠ è½½å®Œæˆçš„äº‹ä»¶ï¼Œè‹¥å½“å‰é¡µé¢åœ¨è§†å£å†…ï¼Œé‡æ–°æ¸²æŸ“å½“å‰é¡µé¢ç¼©ç•¥å›¾
  if (index !== undefined && index !== null) {
    // æ£€æŸ¥å½“å‰ç´¢å¼•æ˜¯å¦åœ¨å¯è§èŒƒå›´å†…ï¼ˆæ‰©å±•3ä¸ªä½ç½®çš„ç¼“å†²åŒºï¼‰
    if ((range[0] || 0) + 0 <= index && (range[1] || 0) + 3 >= index) {
      // ç²¾å‡†æ›´æ–°å•é¡µç¼©ç•¥å›¾
      mainStore.editor?.canvasThumbnails?.updateThumbnail(
        mainStore.editor.slides,
        index,
        mainStore.editor.emitter,
      );
    } else {
      // é€šè¿‡é˜²æŠ–è§¦å‘çš„æ»šåŠ¨æ¸²æŸ“ç¼©ç•¥å›¾
      mainStore.editor?.canvasThumbnails?.renderThumbnail(
        mainStore.editor.slides,
        range[0] || 0,      // æ¸²æŸ“èµ·å§‹ç´¢å¼•
        (range[1] || 0) + 3, // æ¸²æŸ“ç»“æŸç´¢å¼•ï¼ˆæ‰©å±•ç¼“å†²åŒºï¼‰
        mainStore.editor.emitter,
      );
    }
  }
};
```

- topï¼šå…ƒç´ é¡¶éƒ¨åˆ°è§†å£é¡¶éƒ¨çš„è·ç¦»
- leftï¼šå…ƒç´ å·¦è¾¹åˆ°è§†å£å·¦è¾¹çš„è·ç¦»
- bottomï¼šå…ƒç´ åº•éƒ¨åˆ°è§†å£é¡¶éƒ¨çš„è·ç¦»
- rightï¼šå…ƒç´ å³è¾¹åˆ°è§†å£å·¦è¾¹çš„è·ç¦»

## 3. å•é¡µç²¾å‡†æ›´æ–°ï¼ˆéå½“å‰é¡µå˜æ›´ï¼Œä¸å—æ ‡è„æœºåˆ¶å½±å“ï¼‰

åœºæ™¯ï¼šç”¨äºç²¾å‡†æ›´æ–°æŒ‡å®šç´¢å¼•çš„ç¼©ç•¥å›¾

ä¾‹å¦‚å›¾ç‰‡èµ„æºå¼‚æ­¥åŠ è½½å®Œæˆã€éå½“å‰é¡µå˜æ›´ï¼Œå¤„ç†äº†å¹¶å‘åœºæ™¯ä¸‹å®‰å…¨æ›´æ–°çš„é—®é¢˜ã€‚

```javascript
/**
 * 
 * æ›´æ–°æŒ‡å®šç´¢å¼•çš„ç¼©ç•¥å›¾
 * ç”¨äºç²¾å‡†åˆ·æ–°æŸé¡µ(ä¾‹å¦‚å›¾ç‰‡èµ„æºå¼‚æ­¥åŠ è½½å®Œæˆï¼Œéå½“å‰é¡µå˜æ›´)ï¼Œä¸å—â€œéè„å°±è·³è¿‡â€çš„é™åˆ¶
 * 
 * @param slides å¹»ç¯ç‰‡åˆ—è¡¨
 * @param index è¦æ›´æ–°çš„å¹»ç¯ç‰‡ç´¢å¼•
 * @param emitter äº‹ä»¶å‘å°„å™¨
 * @returns 
 */
async updateThumbnail(slides: SlidePart[], index: number, emitter: Emitter<Events>) {
  // ç´¢å¼•è¾¹ç•Œæ£€æŸ¥
  if (index < 0 || index >= slides.length) {
    console.warn("ç´¢å¼•è¶…å‡ºèŒƒå›´ï¼Œæ— æ³•æ·»åŠ ç¼©ç•¥å›¾");
    return;
  }
  
  // è·å–ç›®æ ‡å¹»ç¯ç‰‡
  const slide = slides[index];
  let canvasDom: HTMLCanvasElement | null = document.createElement('canvas');
  
  // è®¾ç½®ç”»å¸ƒå°ºå¯¸
  canvasDom.width = this.width;
  canvasDom.height = this.height;
  
  // è·å–2Dä¸Šä¸‹æ–‡
  let ctx = canvasDom.getContext('2d');
  if (!ctx) {
    console.warn('è·å–ç¼©ç•¥å›¾ä¸Šä¸‹æ–‡å¤±è´¥');
    return;
  }
  
  // è®°å½•æ“ä½œç‰ˆæœ¬å’Œç»“æ„ç‰ˆæœ¬ï¼ˆç”¨äºå¹¶å‘å®‰å…¨ï¼‰
  const opVersion = this._nextOpVersionByIndex(index);
  const expectStructureVersion = this._structureVersion;
  
  // ç»˜åˆ¶ç¼©ç•¥å›¾å¹¶è·å–Blob
  const blob = await this._drawThumbnail(slide, canvasDom, ctx);
  
  // æäº¤æ›´æ–°åˆ°æ•°æ®æ¨¡å‹
  this._commitByIndex(
    index,
    {
      img: blob ? URL.createObjectURL(blob) : '', // åˆ›å»ºBlob URL
      slideRatio: canvasDom.width / canvasDom.height, // è®¡ç®—å®½é«˜æ¯”
      dirty: false, // é‡ç½®è„æ ‡è®°
    },
    opVersion,
    expectStructureVersion
  );
  
  // æ¸…ç†ç”»å¸ƒå¼•ç”¨
  canvasDom = null;
  ctx = null;
  
  // é€šçŸ¥ç¼–è¾‘å™¨å±æ€§æ›´æ–°
  emitter.emit(EmitterEvents.UPDATE_EDITOR_ATTRS);
}
```

## 4. ç”»å¸ƒå¤ç”¨æ›´æ–°ï¼ˆæ€§èƒ½æœ€ä¼˜ï¼‰

```javascript
// é€šè¿‡ä¸»ç”»å¸ƒCanvasæ›´æ–°ç¼©ç•¥å›¾
    async updateThumbnailByCanvas(
        canvasDom: HTMLCanvasElement,
        canvasBgDom: HTMLCanvasElement,
        sizeInfo: ReturnType<typeof calculateSlideSize>,
        index: number,
        emitter: Emitter<Events>,
    ) {
        const updateCanvas = this._updateCanvas;
        const ctx = updateCanvas.getContext('2d');
        if (!ctx) {
            console.warn('è·å–ç¼©ç•¥å›¾ä¸Šä¸‹æ–‡å¤±è´¥');
            return;
        }

        // æ¸…ç©ºç”»å¸ƒ
        ctx.clearRect(0, 0, updateCanvas.width, updateCanvas.height);

        // ç”»èƒŒæ™¯ç”»å¸ƒ
        ctx.drawImage(
            canvasBgDom,
            0,
            0,
            canvasBgDom.width,
            canvasBgDom.height,
            0,
            0,
            updateCanvas.width,
            updateCanvas.height,
        );

        // å°†ä¸»ç”»å¸ƒç”»åˆ°
        ctx.drawImage(
            canvasDom,
            sizeInfo.xOff * this.dpr,
            sizeInfo.yOff * this.dpr,
            sizeInfo.slideWidth * this.dpr,
            sizeInfo.slideHeight * this.dpr,
            0,
            0,
            updateCanvas.width,
            updateCanvas.height,
        );

        const opVersion = this._nextOpVersionByIndex(index);
        const expectStructureVersion = this._structureVersion;
        const blob = await new Promise<Blob | null>((resolve) => {
            updateCanvas.toBlob((blob) => resolve(blob), 'image/png');
        });

        this._commitByIndex(
            index,
            {
                img: blob ? URL.createObjectURL(blob) : '',
                slideRatio: updateCanvas.width / updateCanvas.height,
                dirty: false,
            },
            opVersion,
            expectStructureVersion,
        );

        emitter.emit(EmitterEvents.UPDATE_EDITOR_ATTRS);
    }
```

# å¹¶å‘å®‰å…¨æœºåˆ¶

## åŒé‡ç‰ˆæœ¬æ§åˆ¶

- åºåˆ—ç»´åº¦

åœºæ™¯ï¼šç”¨æ¥è§£å†³åŒä¸€é¡µé¢çš„å¹¶å‘å†²çª

æœºåˆ¶ï¼šæ¯æ¬¡æ¸²æŸ“ç¼©ç•¥å›¾æ—¶é€’å¢

å…·ä½“è§é—®ç­”éƒ¨åˆ†

```javascript
// å¹¶å‘æ§åˆ¶ï¼ˆç´¢å¼•ç»´åº¦ï¼‰ï¼šé’ˆå¯¹æŒ‰ç´¢å¼•æ›´æ–°çš„åœºæ™¯ï¼Œç¡®ä¿ä»…æ›´æ–°æŒ‡å®šç´¢å¼•ä½ç½®
private _opVersionByIndex: Record<number, number> = {};

// é€’å¢å¹¶è¿”å›æŒ‡å®šç´¢å¼•çš„å½“å‰æ“ä½œç‰ˆæœ¬ï¼ˆæŒ‰ç´¢å¼•æ›´æ–°ï¼‰
private _nextOpVersionByIndex(index: number): number {
	this._opVersionByIndex[index] = (this._opVersionByIndex[index] || 0) + 1;
	return this._opVersionByIndex[index];
}

private _commitByIndex(
        index: number,
        draft: {
            img: string;
            slideRatio: number;
            dirty: boolean;
        },
        version: number,
        expectStructureVersion?: number,
    ) {
        // ç‰ˆæœ¬è¿‡æœŸåˆ™ä¸¢å¼ƒ
        if (this._opVersionByIndex[index] !== version) {
            if (draft.img) {
                URL.revokeObjectURL(draft.img);
            }
            return;
        }
    }

```

- ç»“æ„ç»´åº¦

ä¸ºäº†è§£å†³ç´¢å¼•å‡ºé”™çš„é—®é¢˜

å…·ä½“è§é—®ç­”éƒ¨åˆ†

```javascript
// åˆ—è¡¨ç»“æ„ç‰ˆæœ¬ï¼ˆæ’å…¥/åˆ é™¤/ç§»åŠ¨æ—¶é€’å¢ï¼‰ï¼Œç”¨äºå±éšœæ ¡éªŒï¼Œé¿å…ç»“æ„å˜åŒ–åæ—§çš„å¼‚æ­¥ç»“æœè¯¯å†™å…¥
private _structureVersion: number = 0;

// é€’å¢ç»“æ„ç‰ˆæœ¬ï¼ˆåœ¨æ’å…¥/åˆ é™¤/ç§»åŠ¨åˆ—è¡¨æ—¶è°ƒç”¨ï¼‰
private _nextStructureVersion(): number {
	this._structureVersion += 1;
        return this._structureVersion;
}

private _commitByIndex(
        index: number,
        draft: {
            img: string;
            slideRatio: number;
            dirty: boolean;
        },
        version: number,
        expectStructureVersion?: number,
    ) {
        // åˆ—è¡¨ç»“æ„ç‰ˆæœ¬å±éšœæ ¡éªŒï¼šç»“æ„å˜åŒ–åä¸¢å¼ƒæ—§ç»“æœé¿å…é”™ä½
        if (expectStructureVersion !== undefined && this._structureVersion !== expectStructureVersion) {
            if (draft.img) {
               URL.revokeObjectURL(draft.img);
            }
            return;
        }
    }




```

ä¸ºä»€ä¹ˆè¦è¿™æ ·è®¾è®¡ï¼Ÿ

åœºæ™¯ï¼šç”¨æˆ·å¿«é€Ÿæ‹–åŠ¨å¤šä¸ªå¹»ç¯ç‰‡->è§¦å‘å¤šä¸ªå¹¶å‘æ›´æ–°

é—®é¢˜ï¼šåå‘è¯·æ±‚å¯èƒ½å…ˆå‘æŒ¥ï¼Œå¯¼è‡´æœ€ç»ˆçŠ¶æ€é”™è¯¯

è§£å†³æ–¹æ¡ˆï¼šç‰ˆæœ¬å·å±éšœï¼Œç¡®ä¿åªæœ‰æœ€æ–°çš„æœ‰æ•ˆæ›´æ–°è¢«åº”ç”¨

## å†…å­˜å®‰å…¨è®¾è®¡

```javascript
    private _replaceItemAtIndex(
        index: number,
        item: {
            img: string;
            id: number;
            slideRatio: number;
            dirty: boolean;
            slideFileName: string;
            slideId: string;
        },
    ) {
        const prevUrl = this.thumbnailList[index]?.img;
        if (prevUrl) {
	    URL.revokeObjectURL(prevUrl);
        }
        this.thumbnailList[index] = item;
    }
```

å†…å­˜ç®¡ç†ç­–ç•¥

- ä¸»åŠ¨å›æ”¶ï¼šæ¯æ¬¡æ›´æ–°å‰é‡Šæ”¾æ—§çš„Blob URL
- å¼‚å¸¸å¤„ç†ï¼štry-catchä¿æŠ¤ï¼Œé˜²æ­¢å›æ”¶å¤±è´¥å½±å“ä¸»æµç¨‹
- å®¹é”™è®¾è®¡ï¼šå³ä½¿å›æ”¶å¤±è´¥ä¹Ÿç»§ç»­æ‰§è¡Œ

## é¢è¯•é—®ç­”

Qï¼šæˆ‘çœ‹åˆ°ä½ é€šè¿‡é€’å¢æ•°å­—æ¥æ§åˆ¶å¹¶å‘ã€‚ä½†é€šå¸¸æˆ‘ä»¬åšå¹¶å‘æ§åˆ¶ä¼šç”¨å¸ƒå°”é”ï¼ˆtrue/false)æˆ–è€…Promiseé“¾ã€‚ä¸ºä»€ä¹ˆè¦ç”¨é€’å¢æ•°å­—è¿™ç§çœ‹ä¼¼å¤æ‚çš„æ–¹å¼ã€‚
A:
ä¸€å¼€å§‹æ˜¯ç”¨å¸ƒå°”é”åšçš„ã€‚ä½†æ˜¯å‘ç°æœ‰é—®é¢˜
ä¸¾ä¸ªä¾‹å­ï¼š
ç”¨æˆ·å¿«é€Ÿç¿»é¡µ `ç¬¬5é¡µâ†’ç¬¬6é¡µâ†’ç¬¬5é¡µ`æ—¶ï¼š

- ç¬¬ä¸€æ¬¡æ¸²æŸ“ç¬¬5é¡µå¼€å§‹ï¼ˆå¸ƒå°”é”é”å®š)
- ç”¨æˆ·ç¿»åˆ°ç¬¬6é¡µï¼ˆç¬¬5é¡µé”ä»æŒæœ‰)
- ç”¨æˆ·ç¿»å›ç¬¬5é¡µï¼Œè¯·æ±‚è¢«å¸ƒå°”é”æ‹’ç»ï¼ˆå› ä¸ºé”è¿˜åœ¨)
- ç»“æœï¼šç”¨æˆ·çœ‹åˆ°çš„æ˜¯æ—§çš„ç¬¬5é¡µç¼©ç•¥å›¾

è¿™ä¸æ˜¯ç¬¦åˆé¢„æœŸçš„ï¼Œç¼©ç•¥å›¾åº”è¯¥ä¿è¯çš„æ˜¯ç”¨äºéƒ½æ˜¯åŸºäºæœ€æ–°çš„æ“ä½œç”Ÿæˆçš„
å› æ­¤å°±æ”¹æˆç‰ˆæœ¬å·å…è®¸å¹¶å‘ï¼Œæäº¤æ—¶æ ¡éªŒã€‚
åŒæ ·çš„åœºæ™¯ï¼Œç”¨æˆ·å¿«é€Ÿç¿»é¡µ `ç¬¬5é¡µâ†’ç¬¬6é¡µâ†’ç¬¬5é¡µ`æ—¶
æˆ‘ä»¬ç»´æŠ¤äº†ä¸€ä¸ªæŒ‰ç´¢å¼•çš„æ“ä½œç‰ˆæœ¬åˆ—è¡¨_opVersionByIndex

- ç”¨æˆ·ç¿»åˆ°ç¬¬5é¡µâ†’ç¬¬äº”é¡µçš„version=1ï¼Œå¼€å§‹æ¸²æŸ“
- ç”¨æˆ·ç¿»åˆ°ç¬¬6é¡µç¬¬å…­é¡µçš„version=1ï¼Œå¼€å§‹æ¸²æŸ“
- ç”¨æˆ·ç¿»å›ç¬¬5é¡µâ†’ versionr2ï¼Œä¹Ÿå¼€å§‹æ¸²æŸ“ï¼ˆä¸é˜»å¡)
- ç»“æœ:
  - ç¬¬äº”é¡µï¼Œversion=1æ¸²æŸ“å®Œæˆâ†’å‘ç°å½“å‰version=2ï¼Œä¸¢å¼ƒ
  - ç¬¬äº”é¡µï¼Œversion=2æ¸²æŸ“å®Œæˆâ†’ç‰ˆæœ¬åŒ¹é…ï¼Œæ˜¾ç¤º
  - ç¬¬å…­é¡µï¼Œversion=1æ¸²æŸ“å®Œæˆâ†’ç‰ˆæœ¬åŒ¹é…ï¼Œæ˜¾ç¤º

è¿™ç±»ä¼¼äºä¹è§‚é”å’Œæ‚²è§‚é”ã€‚
å¸ƒå°”é”æ˜¯ä¸€ç§æ‚²è§‚é”ï¼Œä¸»è¦ç”¨äºæ“ä½œä¸å¯ä¸¢å¼ƒï¼Œå†²çªåæœä¸¥é‡çš„åœºæ™¯ï¼Œæ¯”å¦‚è¯´ä¸€äº›è¡¨å•çš„ç¼–è¾‘ä¿å­˜
ä¹è§‚é”é”æ›´é€‚åˆç”¨äºCanvasç»˜åˆ¶ç¼©ç•¥å›¾çš„åœºæ™¯ï¼Œç”¨ä¸€äº›å¹¶å‘çš„ä¸¢å¼ƒæŸè€—æ¥ä¿éšœç”¨æˆ·ä½“éªŒ
Qï¼šé‚£æˆ‘çœ‹é€’å¢æ•°å­—å·²ç»å¯ä»¥å¯¹ç‰ˆæœ¬è¿›è¡Œæ§åˆ¶äº†ï¼Œä¸ºä»€ä¹ˆè¯´æ˜¯åŒå±‚åœºæ™¯æ§åˆ¶å‘¢ï¼Ÿ
Aï¼šè¿™ä¿©ä¸€ä¸ªæ˜¯å¯¹å•é¡µå¹¶å‘çš„åœºæ™¯æ§åˆ¶ã€‚ä¸€ä¸ªæ˜¯å¯¹åˆ—è¡¨ç»“æ„æ“ä½œçš„åœºæ™¯æ§åˆ¶.
ä¸¾ä¸ªä¾‹å­ï¼š
å‡è®¾å½“å‰æœ‰3é¡µç¼©ç•¥å›¾ï¼Œç´¢å¼•æ˜¯[0,1,2]

1. æ—¶é—´t0ï¼šç”¨æˆ·åœ¨ç¬¬2é¡µï¼ˆç´¢å¼•2ï¼‰è§¦å‘æ¸²æŸ“â†’version-1
2. æ—¶é—´t1ï¼šç”¨æˆ·åœ¨ç¬¬1é¡µå‰æ–°å¢äº†ä¸€é¡µï¼Œåˆ—è¡¨å˜æˆ[0ï¼Œ1ï¼Œ(æ–°)ï¼Œ2]
   1. åŸæ¥ç´¢å¼•2çš„é¡µï¼Œç°åœ¨å˜æˆäº†ç´¢å¼•3
3. æ—¶é—´t2ï¼št0å‘èµ·çš„æ¸²æŸ“å®Œæˆï¼Œå¸¦ç€ index=2ï¼Œversion=1

é—®é¢˜æ¥äº†ï¼š

- _opVersionByIndex[2]æ£€æŸ¥é€šè¿‡ï¼ˆå› ä¸ºç¬¬2é¡µç°åœ¨æ˜¯æ–°é¡µé¢ï¼Œç‰ˆæœ¬æ˜¯åˆå§‹å€¼)
- ä½†æ¸²æŸ“ç»“æœæ”¾é”™äº†ä½ç½®ï¼å®ƒåº”è¯¥æ”¾åˆ°ç´¢å¼•3ï¼Œå´æ”¾åˆ°äº†ç´¢å¼•2

è¿™å°±æ˜¯ç»“æ„å˜åŒ–å¯¼è‡´çš„ç´¢å¼•æ¼‚ç§»é—®é¢˜ï¼Œä»…é æ“ä½œç‰ˆæœ¬æ— æ³•å‘ç°ã€‚

# ç¦»å±æ¸²æŸ“ä¼˜åŒ–&é‡è¯•æœºåˆ¶

```javascript
    async drawThumbnail(
        slide: SlidePart,
        canvasDom: HTMLCanvasElement = this._canvas,
        ctx: CanvasRenderingContext2D = this._ctx!,
    ): Promise<Blob | null> {
        // æ¸…ç©ºç”»å¸ƒ
        ctx.clearRect(0, 0, canvasDom.width, canvasDom.height);

        // å…³é”®ç‚¹1:ç¦»å±èµ„æºç­‰å¾…
        const isOffscreen = document.visibilityState === 'hidden';
        if (isOffscreen) {
            await this._waitSlideAssets(slide, 1500);
            await waitForAnimationFrame();
        }

        // æ¸²æŸ“
        await this.renderSpTree(slide, ctx, undefined);

        // å…³é”®ç‚¹2:ç¦»å±æ¸²æŸ“é‡è¯•æœºåˆ¶
        let blob = await canvasDom.toBlob();

        if (!blob && isOffscreen) {
            await waitForAnimationFrame();
            blob = await canvasDom.toBlob();
        }

        return blob;
    }
```

Q:ä¸ºä»€ä¹ˆè¦åšç¦»å±æ¸²æŸ“ä¼˜åŒ–ï¼Ÿ
Aï¼šä¸ºäº†è§£å†³ç¦»å±æ—¶æ¸²æŸ“å›¾åŠ è½½å¼‚å¸¸çš„é—®é¢˜ã€‚
èƒŒæ™¯æ˜¯å¤šæ ‡ç­¾é¡µæµ‹è¯•ä¸­ï¼Œå‘ç°PPTç¼©ç•¥å›¾åœ¨ç¦»å±çŠ¶æ€ä¸‹æœ‰ä¸¤ç±»æ¸²æŸ“å¼‚å¸¸

1. **å†…å®¹ç¼ºå¤±**ï¼šå›¾ç‰‡èµ„æºæœªåŠ è½½ï¼Œç¼©ç•¥å›¾éƒ¨åˆ†ç©ºç™½
2. **å®Œå…¨å¤±è´¥**ï¼šæ•´ä¸ªç¼©ç•¥å›¾ä¸ºç©ºï¼Œcanvas.toBlobOï¼‰è¿”å›null

é€šè¿‡Chrome Performanceé¢æ¿é—®é¢˜æ’æŸ¥ä¹‹åå‘ç°ï¼š

1. **Network**é¢æ¿ï¼š
   a. ç¦»å±æ—¶å›¾ç‰‡è¯·æ±‚é•¿æ—¶é—´å¤„äºstalledçŠ¶æ€ï¼Œä¼˜å…ˆçº§æ˜¾ç¤ºä¸ºLow.
   b. è¿™å¯¼è‡´drawImage(æ—¶èµ„æºæœªå°±ç»ªï¼Œå¼•å‘å†…å®¹ç¼ºå¤±
2. **Frames**é¢æ¿ï¼š
   a. ç¦»å±æ—¶ï¼šæ¸²æŸ“å¸§æå…¶ç¨€ç–ï¼Œæœ‰æ—¶å‡ ç§’æ‰ä¸€å¸§ã€‚
   b. å¯è§æ—¶ï¼šå¯ä»¥çœ‹åˆ°å¯†é›†çš„ç»¿è‰²å¸§å—ã€‚
3. Consoleæµ‹è¯•ï¼šç¦»å±æ—¶toBlobOåŒæ­¥è¿”å›nullï¼Œä½†ç»˜åˆ¶ä»£ç ç¡®å®æ‰§è¡Œäº†

åŸºäºè¿™äº›ç°è±¡ï¼Œæˆ‘æŸ¥é˜…äº†Chromeçš„æ¸²æŸ“ä¼˜åŒ–æ–‡æ¡£ï¼Œäº†è§£åˆ°ï¼Œç¦»å±æ—¶:

- æµè§ˆå™¨ä¼šé™ä½æ ‡ç­¾çš„èµ„æºåŠ è½½ä¼˜å…ˆçº§ï¼Œå¯¼è‡´å›¾ç‰‡èµ„æºæ²¡æœ‰åŠ è½½å‡ºæ¥ã€‚
- ç¦»å±ä¼šå¤§å¹…èŠ‚æµrequestAnimationFrameè°ƒç”¨ï¼Œç¦»å±Canvasçš„æ¸²æŸ“å¸§ç‡ä¼šå¤§å¹…ä¸‹é™ï¼ŒGPUæ”¶ä¸åˆ°æ–°çš„å†…å®¹ï¼Œå°±ä¸ä¼šæ›´æ–°ä½å›¾ï¼Œä»è€Œå¯¼è‡´toBlobOè¯»å–æ—¶Canvasç¼“å†²åŒºæœªæ›´æ–°ï¼Œæ‹¿åˆ°nulå€¼

## ç¬¬ä¸€ç‰ˆï¼šsetTimeoutç­‰å¾…

ä¸ºäº†è§£å†³èµ„æºè°ƒåº¦ä¼˜å…ˆçº§é™ä½çš„é—®é¢˜ï¼Œæˆ‘å†™äº†ä¸€ä¸ªsetTimeoutï¼Œå»¶è¿Ÿè·å–å›¾ç‰‡çš„æ—¶é—´ï¼Œå†è¿›è¡Œç»˜åˆ¶ã€‚
è¿™ä¸ªéƒ½å†³äº†å›¾ç‰‡åšå¤±çš„é—®é¢˜ï¼Œä½†éƒ¨åˆ†èƒ½ç•¥å›¾camvastoBlobè¿˜æ˜¯ä¸ºnullï¼Œè¿™æ˜¯å› ä¸ºç¦»é¡¶çš„æ—¶å€™å®šå¯¹å™¨ä¹Ÿè¢«èŠ‚æµäº†ï¼Œä¸ä»…æƒ…åº¦éšœä½ï¼Œå¹¶ä¸”SctTimcouE|æ— æ³•å‘Šè¯‰å¯¹è§ˆå™¨ç«‹åŠ é…’å¯¹ã€‚å¯ä»¥ç”¨PeestAinatfonfroo5ä¸ºé‡Œå”æœ‰çš„é—´æ˜ä¸¤æ­¥

## æœ€ç»ˆçš„æ–¹æ¡ˆæ˜¯ï¼šç¦»å±æ£€æµ‹&é‡è¯•æœºåˆ¶

é€šè¿‡document.visibilityStateæ£€æµ‹ç¦»å±çŠ¶æ€.
å½“ç¦»å±çŠ¶æ€çš„æ—¶å€™ã€‚è®¾å®š1.5sçš„å®šæ—¶å™¨ï¼Œä¿è¯å›¾ç‰‡åŠ è½½ã€‚å› ä¸ºç”¨æˆ·ä¸çœ‹çš„æƒ…å†µä¸‹ï¼Œæ­£ç¡®æ€§æ¯”å®æ—¶æ€§æ›´é‡è¦ã€‚
æ¥ç€æ£€æµ‹canvas.toBlob()çš„ç»“æœï¼Œå¦‚æœæ²¡æœ‰å€¼ï¼Œå°±è°ƒç”¨requestAnimationFrameç­‰å¾…ä¸€å¸§ï¼Œæ­¤æ—¶ä¼šè§¦å‘æµè§ˆå™¨çš„åŠ æ€¥æ¸²æŸ“è·¯å¾„ï¼ŒGPUä¼šä¼˜å…ˆæ¸²æŸ“Canvasçš„å†…å®¹.

# ğŸ‘·â€â™€ï¸äº‹ä»¶é©±åŠ¨çš„åä½œæœºåˆ¶

ä¸ä¸»åº”ç”¨çš„é€šä¿¡

```javascript
1//é€šè¿‡äº‹ä»¶å‘å°„å™¨é€šçŸ¥UIæ›´æ–°
2 emitter.emit(EmitterEvents.UPDATE_EDITOR_ATTRS);//ç›‘å¬èµ„æºåŠ è½½äº‹ä»¶
3 emitter.on(EmitterEvents.IMAGE_LOADED, onImageLoaded);
4 emitter.on(EmitterEvents.RENDER_VIEWPORT_THUMBNAILS, onThumb);

```

è®¾è®¡æ€æƒ³ï¼šç¼©ç•¥å›¾ç³»ç»Ÿä¸æ˜¯å­¤ç«‹çš„ï¼Œå®ƒ
1.ç›‘å¬ä¸»ç”»å¸ƒçš„æ¸²æŸ“äº‹ä»¶
2.å“åº”èµ„æºåŠ è½½å®Œæˆäº‹ä»¶
3.é€šçŸ¥UIå±‚æ›´æ–°æ˜¾ç¤º


# **æ ‡è„æœºåˆ¶**

## **æ ‡è„**

### **åœºæ™¯1ï¼šé¡µé¢åˆ›å»ºï¼ˆåˆå§‹åŒ–ï¼Œç»Ÿä¸€æ ‡è„ï¼‰**

```js
constructor() {
  // åˆå§‹åŒ–æ—¶æ‰€æœ‰ç¼©ç•¥å›¾éƒ½æ˜¯è„çš„
  this.thumbnailList = slides.map((_, index) => ({
    // ...å…¶ä»–å­—æ®µ
    dirty: true,  // åˆå§‹çŠ¶æ€ï¼šéœ€è¦æ¸²æŸ“
  }));
}
```

### **åœºæ™¯2ï¼šå¹»ç¯ç‰‡å†…å®¹å˜æ›´æ—¶**

å½“ç”¨æˆ·ç¼–è¾‘PPTæ—¶ï¼š

```js
// ç”¨æˆ·ä¿®æ”¹äº†ç¬¬3é¡µçš„å†…å®¹
this.thumbnailList[2].dirty = true;  // æ ‡è®°ä¸ºéœ€è¦æ›´æ–°

// ç”¨æˆ·ä¿®æ”¹äº†ç¬¬5é¡µçš„æ ·å¼
this.thumbnailList[4].dirty = true;
```

#### **åœºæ™¯3ï¼šèµ„æºåŠ è½½å®Œæˆå**

* å›¾ç‰‡åŠ è½½
* èƒŒæ™¯å˜åŒ–

```js
// å›¾ç‰‡å¼‚æ­¥åŠ è½½å®Œæˆæ—¶
emitter.on(EmitterEvents.IMAGE_LOADED, (fileName) => {
  const index = this.findSlideIndexByFileName(fileName);
  if (index !== -1) {
    this.thumbnailList[index].dirty = true;  // éœ€è¦é‡æ–°æ¸²æŸ“
    this.updateThumbnail(index);             // è§¦å‘æ›´æ–°
  }
});
```

### **æ ‡éè„**

æˆåŠŸæ¸²æŸ“åï¼š

```js
async renderThumbnail() {
  // ...æ¸²æŸ“é€»è¾‘
  const blob = await this.drawThumbnail(slide, canvasDom, ctx);

  // æ¸²æŸ“æˆåŠŸåæ¸…é™¤è„æ ‡è®°
  this._commitByIndex(index, {
    img: blob ? URL.createObjectURL(blob) : '',
    slideRatio: canvasDom.width / canvasDom.height,
    dirty: false, // âœ“ æ¸…é™¤è„æ ‡è®°ï¼
  }, opVersion, expectStructureVersion);
}
```


## **è·³è¿‡æ ‡è„**

```js
async updateThumbnail(slides, index, emitter) {
  // ç”¨äºç²¾å‡†åˆ·æ–°æŸé¡µï¼ˆä¾‹å¦‚å›¾ç‰‡èµ„æºå¼‚æ­¥åŠ è½½å®Œæˆï¼‰
  // ä¸å—â€œéè„å°±è·³è¿‡â€çš„é™åˆ¶ï¼Œå¼ºåˆ¶æ›´æ–°
  // ....ç›´æ¥æ¸²æŸ“ï¼Œä¸æ£€æŸ¥dirtyæ ‡è®°
}
```

### **ä½¿ç”¨åœºæ™¯ï¼š**

1. å¼‚æ­¥å›¾ç‰‡åŠ è½½å®Œæˆ
2. ä»ç¼“å­˜æ¢å¤æ•°æ®
3. ç”¨æˆ·æ‰‹åŠ¨åˆ·æ–°

# **å¼€å‘ç¢°åˆ°çš„é—®é¢˜**

## **æ¸²æŸ“é”™ä¹±é—®é¢˜**

åœ¨æœ€å¼€å§‹çš„æ–¹æ¡ˆä¸­ï¼Œæœ‰ä¸¤ä¸ªç”»å¸ƒï¼š

* **ç¼©ç•¥å›¾ç”»å¸ƒ** ï¼šè´Ÿè´£æ‰€æœ‰ç¼©ç•¥å›¾çš„ç»˜åˆ¶
* **ä¸»ç”»å¸ƒ** ï¼šè´Ÿè´£å½“å‰é€‰ä¸­å¹»ç¯ç‰‡é¡µé¢çš„ç»˜åˆ¶

ç¼©ç•¥å›¾ç”»å¸ƒçš„ç»˜åˆ¶æ˜¯ä¸²è¡Œçš„ï¼Œå³ç»˜åˆ¶å®Œç¬¬ä¸€é¡µæ‰ä¼šç»˜åˆ¶ç¬¬äºŒé¡µã€‚
ä½†æ˜¯å› ä¸ºå¹»ç¯ç‰‡ä¸­æœ‰å›¾ç‰‡å…ƒç´ ï¼Œå›¾ç‰‡å…ƒç´ ä¸åº”è¯¥é˜»å¡ç¼©ç•¥å›¾çš„ç»˜åˆ¶ã€‚æ‰€ä»¥å›¾ç‰‡æ˜¯åœ¨å¼‚æ­¥å›è°ƒä¸­æ¸²æŸ“ï¼Œè¿™å¯¼è‡´äº†æ¸²æŸ“é”™ä¹±é—®é¢˜ã€‚

**ä¸¾ä¸ªä¾‹å­ï¼š**
å¦‚æœæ¸²æŸ“ç¬¬1é¡µåç«‹å³æ¸²æŸ“ç¬¬2é¡µã€‚å…¶ä¸­ç¬¬1é¡µæœ‰å›¾ç‰‡èµ„æºï¼Œä¸ä¼šé˜»å¡æ¸²æŸ“ï¼Œè€Œæ˜¯åœ¨å¼‚æ­¥å›è°ƒä¸­æ¸²æŸ“ã€‚
å½“åªæœ‰ä¸€ä¸ªç”»å¸ƒçš„æ—¶å€™ï¼Œä¼šå¯¼è‡´å±äºç¬¬1é¡µçš„å›¾ç‰‡èµ„æºè¯·æ±‚å›æ¥ä¹‹åï¼Œæ¸²æŸ“åˆ°ç¬¬2é¡µï¼Œé€ æˆç”»é¢é”™ä¹±ã€‚

**è§£å†³æ–¹æ¡ˆï¼š**
æˆ‘é‡‡ç”¨äº†æ¯æ¬¡æ¸²æŸ“åˆ›å»ºæ–°çš„ä¸´æ—¶Canvasçš„æ–¹æ¡ˆã€‚è¿™ä¸ªæ”¹å˜è™½ç„¶å¢åŠ äº†å¾®å°çš„åˆ›å»ºå¼€é”€ï¼Œä½†å½»åº•è§£å†³äº†å¹¶å‘æ¸²æŸ“çš„å®‰å…¨æ€§é—®é¢˜ã€‚

## **Qï¼šä¸´æ—¶Canvasçš„å†…å­˜æ€ä¹ˆç®¡ç†ï¼Ÿä¸æ€•æ³„æ¼å—ï¼Ÿ**

**Aï¼š** æˆ‘ä»¬æœ‰ä¸‰å±‚å†…å­˜å®‰å…¨ä¿éšœï¼š

1. **å±€éƒ¨å˜é‡ä½œç”¨åŸŸ** ï¼šä¸´æ—¶canvasåœ¨æ–¹æ³•å†…åˆ›å»ºï¼Œæ–¹æ³•ç»“æŸå¤±å»å¼•ç”¨
2. **ä¸»åŠ¨ç½®ç©º** ï¼š`(canvasDom as any) = null` æ˜¾å¼åˆ‡æ–­å¼•ç”¨
3. **Blob URLç®¡ç†** ï¼šç”Ÿæˆçš„ç¼©ç•¥å›¾å›¾ç‰‡URLæœ‰ç‹¬ç«‹çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†

æˆ‘ä»¬åšè¿‡å†…å­˜æµ‹è¯•ï¼Œè¿ç»­æ¸²æŸ“100é¡µPPTï¼Œå†…å­˜å¢é•¿åœ¨åˆç†èŒƒå›´å†…ï¼Œä¸”èƒ½è¢«æ­£å¸¸GCå›æ”¶ã€‚

## **Qï¼šä¸ºä»€ä¹ˆä¸ç”¨å¯¹è±¡æ± å¤ç”¨Canvasï¼Ÿ**

**Aï¼š** æˆ‘ä»¬è€ƒè™‘è¿‡å¯¹è±¡æ± ï¼Œä½†æƒè¡¡åæ”¾å¼ƒäº†ï¼š

1. **å¤æ‚åº¦** ï¼šéœ€è¦ç»´æŠ¤æ± çŠ¶æ€ï¼Œæ¸…ç†Canvasä¸Šä¸‹æ–‡
2. **æ”¶ç›Šæœ‰é™** ï¼šåˆ›å»ºCanvasçš„æˆæœ¬å…¶å®å¾ˆä½ï¼ˆæµ‹è¯•æ˜¾ç¤º < 0.1msï¼‰
3. **é£é™©** ï¼šæ± åŒ–å¯èƒ½å¼•å…¥æ–°çš„çŠ¶æ€æ±¡æŸ“bug

## Q:é‚£ä¸»ç”»å¸ƒä¸ºä»€ä¹ˆå¯ä»¥å¤ç”¨ï¼Ÿ

**Aï¼š**_updateCanvasçš„åœºæ™¯å®Œå…¨ä¸åŒ
å®ƒä¸æ¶‰åŠè§£æOpenXMLå’Œæ„å»ºæ¸²æŸ“æ ‘
åªæ˜¯ç®€å•çš„drawImage æ‹·è´æ“ä½œï¼ŒçŠ¶æ€ç®€å•
ä¸”æ˜¯ä¸²è¡Œæ“ä½œï¼Œæ²¡æœ‰å¹¶å‘æ±¡æŸ“é£é™©
æ‰€ä»¥å¯¹äºè¿™ä¸ªç‰¹å®šåœºæ™¯ï¼Œå¤ç”¨æ˜¯å®‰å…¨ä¸”é«˜æ•ˆçš„ã€‚
