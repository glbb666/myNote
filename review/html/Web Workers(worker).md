#  ä»€ä¹ˆæ˜¯WebWorker

web worker æ˜¯è¿è¡Œåœ¨åå°çš„ JavaScriptï¼Œä¸ä¼šå½±å“é¡µé¢çš„æ€§èƒ½ã€‚

### Web Workerç®€ä»‹

å½“åœ¨ HTML é¡µé¢ä¸­æ‰§è¡Œè„šæœ¬æ—¶ï¼Œé¡µé¢çš„çŠ¶æ€æ˜¯ä¸å¯å“åº”çš„ï¼Œç›´åˆ°è„šæœ¬å·²å®Œæˆã€‚

web worker æ˜¯è¿è¡Œåœ¨åå°çš„ JavaScriptï¼Œç‹¬ç«‹äºå…¶ä»–è„šæœ¬ï¼Œä¸ä¼šå½±å“é¡µé¢çš„æ€§èƒ½ã€‚æ‚¨å¯ä»¥ç»§ç»­åšä»»ä½•æ„¿æ„åšçš„äº‹æƒ…ï¼šç‚¹å‡»ã€é€‰å–å†…å®¹ç­‰ç­‰ï¼Œè€Œæ­¤æ—¶ web worker åœ¨åå°è¿è¡Œã€‚

## 

### ä½¿ç”¨æ–¹æ³•

1. åˆ›å»º**å¤–éƒ¨è„šæœ¬**ã€‚

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬åˆ›å»ºäº†è®¡æ•°è„šæœ¬ã€‚è¯¥è„šæœ¬å­˜å‚¨äº"demo_workers.js" æ–‡ä»¶ä¸­ï¼š

```js
  // onmessage || addEventListener('message', fun, false)
  self.addEventListener('message', function (e) {
    // ç›‘å¬ä¸»çº¿ç¨‹å‘é€çš„æ¶ˆæ¯
    // å‘é€æ¶ˆæ¯ç»™ä¸»çº¿ç¨‹
    self.postMessage('You said: ' + e.data);
  }, false);

  // å…³é—­è¿æ¥
  self.close();

  // onerror
```

ä»¥ä¸Šä»£ç ä¸­é‡è¦çš„éƒ¨åˆ†æ˜¯ **postMessage()** æ–¹æ³•ï¼Œå®ƒç”¨äºå‘ HTML é¡µé¢ä¼ å›ä¸€æ®µæ¶ˆæ¯ã€‚

2. åˆ›å»º Worker å¯¹è±¡ ç”¨ onmessage æ–¹æ³•ç›‘å¬ worker å‘é€çš„æ¶ˆæ¯ã€‚

```js
  if(typeof(w)=="undefined") {
    w = new Worker("demo_workers.js");
    w.onmessage = function(event) {
      // å¤„ç†...
    };
  }
```

3. ä¸»çº¿ç¨‹è°ƒç”¨ postMessage å‘ worker å¯¹è±¡å‘æ¶ˆæ¯

```js
  w.postMessage('ok');
  w.postMessage({ name: 'a', age: '12' });
```

4. ç»ˆæ­¢ Worker

```js
  w.terminate();
```



### æ³¨æ„äº‹é¡¹

1. **åŒæºé™åˆ¶** åˆ†é…ç»™ Worker çº¿ç¨‹è¿è¡Œçš„è„šæœ¬æ–‡ä»¶ï¼Œå¿…é¡»ä¸ä¸»çº¿ç¨‹çš„è„šæœ¬æ–‡ä»¶åŒæºã€‚

2. **DOM é™åˆ¶** Worker çº¿ç¨‹æ‰€åœ¨çš„å…¨å±€å¯¹è±¡ï¼Œä¸ä¸»çº¿ç¨‹ä¸ä¸€æ ·ï¼Œæ— æ³•è¯»å–ä¸»çº¿ç¨‹æ‰€åœ¨ç½‘é¡µçš„ DOM å¯¹è±¡ï¼Œä¹Ÿæ— æ³•ä½¿ç”¨ documentã€windowã€parent è¿™äº›å¯¹è±¡ã€‚ä½†æ˜¯ï¼ŒWorker çº¿ç¨‹å¯ä»¥è®¿é—® navigator å¯¹è±¡å’Œ location å¯¹è±¡ã€‚

3. **é€šä¿¡è”ç³»** Worker çº¿ç¨‹å’Œä¸»çº¿ç¨‹ä¸åœ¨åŒä¸€ä¸ªä¸Šä¸‹æ–‡ç¯å¢ƒï¼Œå®ƒä»¬ä¸èƒ½ç›´æ¥é€šä¿¡ï¼Œå¿…é¡»é€šè¿‡æ¶ˆæ¯å®Œæˆã€‚

4. **è„šæœ¬é™åˆ¶** Worker çº¿ç¨‹ä¸èƒ½æ‰§è¡Œ alert() æ–¹æ³•å’Œ confirm() æ–¹æ³•ï¼Œä½†å¯ä»¥ä½¿ç”¨ XMLHttpRequest å¯¹è±¡å‘å‡º AJAX è¯·æ±‚ã€‚

5. **æ–‡ä»¶é™åˆ¶** Worker çº¿ç¨‹æ— æ³•è¯»å–æœ¬åœ°æ–‡ä»¶ï¼Œå³ä¸èƒ½æ‰“å¼€æœ¬æœºçš„æ–‡ä»¶ç³»ç»Ÿï¼ˆfile://ï¼‰ï¼Œå®ƒæ‰€åŠ è½½çš„è„šæœ¬ï¼Œå¿…é¡»æ¥è‡ªç½‘ç»œã€‚

   æ³¨æ„ï¼šå¦‚æœworkeræ˜¯å¼•ç”¨çš„åˆ«çš„jsæ–‡ä»¶ï¼Œåº”è¯¥ç”¨æœåŠ¡å™¨è¿›è¡Œè¯»å–

   ```js
   const express = require('express');
   const static = require('express-static');
   var app = new express();
   app.use(static('./'));
   console.log('åˆ›å»º');
   app.listen(8080);
   ```

   ä»¥ä¸Šæ˜¯æœåŠ¡å™¨çš„ä»£ç ï¼ŒæœåŠ¡å™¨nodejsåº”è¯¥æ”¾åœ¨æ–‡ä»¶çš„æœ€å¤–å±‚ï¼Œå› ä¸ºå®ƒåªä¼šå¾€å†…éƒ¨è®¿é—®äº†ã€‚

### ä½¿ç”¨å®ä¾‹

1. æµè§ˆå™¨è½®è¯¢
2. Worker åˆ›å»ºæ–° Worker

### æ›´å¤š

#### ä¸»çº¿ç¨‹

- Worker.onerrorï¼šæŒ‡å®š error äº‹ä»¶çš„ç›‘å¬å‡½æ•°ã€‚
- Worker.onmessageï¼šæŒ‡å®š message äº‹ä»¶çš„ç›‘å¬å‡½æ•°ï¼Œå‘é€è¿‡æ¥çš„æ•°æ®åœ¨Event.dataå±æ€§ä¸­ã€‚
- Worker.onmessageerrorï¼šæŒ‡å®š messageerror äº‹ä»¶çš„ç›‘å¬å‡½æ•°ã€‚å‘é€çš„æ•°æ®æ— æ³•åºåˆ—åŒ–æˆå­—ç¬¦ä¸²æ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªäº‹ä»¶ã€‚
- Worker.postMessage()ï¼šå‘ Worker çº¿ç¨‹å‘é€æ¶ˆæ¯ã€‚
- Worker.terminate()ï¼šç«‹å³ç»ˆæ­¢ Worker çº¿ç¨‹ã€‚

#### Worker çº¿ç¨‹

Web Worker æœ‰è‡ªå·±çš„å…¨å±€å¯¹è±¡ï¼Œä¸æ˜¯ä¸»çº¿ç¨‹çš„windowï¼Œè€Œæ˜¯ä¸€ä¸ªä¸“é—¨ä¸º Worker å®šåˆ¶çš„å…¨å±€å¯¹è±¡ã€‚å› æ­¤å®šä¹‰åœ¨windowä¸Šé¢çš„å¯¹è±¡å’Œæ–¹æ³•ä¸æ˜¯å…¨éƒ¨éƒ½å¯ä»¥ä½¿ç”¨ã€‚

Worker çº¿ç¨‹æœ‰ä¸€äº›è‡ªå·±çš„å…¨å±€å±æ€§å’Œæ–¹æ³•ã€‚

- self.nameï¼š Worker çš„åå­—ã€‚è¯¥å±æ€§åªè¯»ï¼Œç”±æ„é€ å‡½æ•°æŒ‡å®šã€‚
- self.onmessageï¼šæŒ‡å®šmessageäº‹ä»¶çš„ç›‘å¬å‡½æ•°ã€‚
- self.onmessageerrorï¼šæŒ‡å®š messageerror äº‹ä»¶çš„ç›‘å¬å‡½æ•°ã€‚å‘é€çš„æ•°æ®æ— æ³•åºåˆ—åŒ–æˆå­—ç¬¦ä¸²æ—¶ï¼Œä¼šè§¦å‘è¿™ä¸ªäº‹ä»¶ã€‚
- self.close()ï¼šå…³é—­ Worker çº¿ç¨‹ã€‚
- self.postMessage()ï¼šå‘äº§ç”Ÿè¿™ä¸ª Worker çº¿ç¨‹å‘é€æ¶ˆæ¯ã€‚
- self.importScripts()ï¼šåŠ è½½ JS è„šæœ¬ã€‚

### æ‰©å±•

[â˜„ï¸ Service Worker](https://juejin.im/post/5b06a7b3f265da0dd8567513)

[ğŸ’¥ Shared Worker](https://www.zhuwenlong.com/blog/article/590ea64fe55f0f385f9a12e5)