### `setState`调用的详细过程

#### 1. 处理更新请求

- **调用 `setState`**：

  - 当你调用 `setState` 方法时，React 会将传入的更新对象与组件当前的状态合并。这是为了确保组件的状态是最新的。
- **更新队列管理**：

  - `setState` 会调用 `updater` 对象的 `enqueueSetState` 方法，将 `update` 放入更新队列中。
  - 每个组件实例对应一个 `fiber` 节点，该节点包含一个 `updateQueue`，用于存储状态更新。

#### 2. 找到 `rootFiber` 并处理优先级

- **寻找 `rootFiber`**：

  - React 会从目标 `fiber` 节点开始，向上遍历找到 `rootFiber` 对象。`rootFiber` 是整个组件树的根节点。
- **更新过期时间**：

  - 一旦找到 `rootFiber`，React 会遍历 `fiber` 树，并更新所有相关节点的过期时间。
  - 如果相关节点有镜像节点，也会更新镜像节点的过期时间。

#### 3. 优先级判断和任务调度

- **判断任务优先级**：

  - React 会比较 `FiberRoot` 上的 `callback` 的过期时间和当前任务的过期时间，以确定任务的优先级。
  - 如果当前任务是高优先级任务，React 会打断正在执行的低优先级任务，以确保高优先级任务能够尽快执行。
- **同步和异步任务处理**：

  - **同步任务**：如果当前任务是同步任务，React 会检查同步队列是否存在。如果不存在，则创建一个新的同步队列，并将同步任务入队。创建队列时会进行一次调度，以确保任务能够尽快执行。
  - **异步任务**：如果当前任务是异步任务，React 会将任务包装为渲染函数，并将其赋值给 `root.callbackNode`，等待空闲时间片段来执行这些任务。

#### 4. 执行和提交更新

- **协调阶段**：

  - 在协调阶段，React 会在镜像树上执行变更计算，并生成副作用链表，记录所有需要更新的节点。
- **提交阶段**：

  - 在提交阶段，React 会遍历副作用链表，将所有变更应用到实际的 DOM 中。
  - 最后，镜像树会替换当前树，成为新的 `current tree`。

### 总结

- **状态更新**：`setState` 调用后，更新对象被合并到组件状态中。
- **更新队列**：更新被加入 `fiber` 节点的更新队列中。
- **优先级处理**：React 找到 `rootFiber` 并处理任务优先级，决定同步或异步执行更新。
- **协调和提交**：更新过程分为协调和提交两个阶段，分别计算变更并应用到实际的 DOM 中。

这个过程确保了React能够高效地处理组件状态的更新，保持UI的一致性和性能。如果有更多关于某个步骤的具体细节或其他问题，请告诉我！
