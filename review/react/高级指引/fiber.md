### 什么是Fiber

Fiber 是 React 16 中引入的新调度器算法，用于优化 React 应用程序的渲染性能。

### 什么是Fiber节点

在 React 中，每个组件都有一个对应的 Fiber 节点。Fiber 节点存储了组件的状态、属性、类型以及对应的 DOM 节点等信息。Fiber 节点构成Fiber树。

Fiber节点是React Fiber架构中用来分解和管理渲染任务的“最小单位”。这种方式可以避免长时间占用主线程，从而提高应用程序的响应性和性能。

### Fiber的优先级

React内部有一个优先级系统，可以根据不同类型的更新分配不同的优先级。比如：

* **同步更新（如事件处理）** ：通常具有最高的优先级，React会立即处理这些更新。
* **动画更新** ：也具有较高的优先级，使得动画可以流畅执行。
* **数据获取** ：这类更新的优先级可能较低，可以推迟执行，直到所有高优先级的任务完成。
* **离屏更新** ：对于不可见的组件（例如滚动屏幕外的内容），它们的更新优先级通常是最低的，因为用户当前看不到它们的变化。

通过这个优先级我们可以获取一个该更新任务必须执行的截止时间，优先级越高那么截止时间就越近，反之亦然。这个截止时间是用来判断该任务是否已经过期，如果过期的话就会马上执行该任务。

截止时间低的一般在浏览器的主线程空闲时才执行。

### 执行与中断

当开始执行更新任务时，如果有新的更新任务进 来，那么调度器就会按照两者的优先级大小来进行决策会判断两个任务的优先级高低。假如新任务优先级高，那么打断旧的任务，重新开始，否则继续执行任务。

中断的任务不会被遗忘。一旦高优先级任务完成，React可以选择合适的时机回到之前被中断的任务，继续之前的工作。

Fiber 还引入了一些新的 React 特性，例如时间分片和并发模式。

#### 时间分片

##### 是什么

时间分片可以让 React 在渲染期间暂停和继续工作，以避免阻塞 UI 更新。

##### 原理

时间分片是一种调度机制，它不是依赖于传统的线程管理，而是基于浏览器提供的 requestIdleCallback API。该API允许开发者在浏览器的空闲时段执行低优先级的任务，而不影响高优先级的任务，如动画和输入响应。

React 使用这个API来实现时间分片。当React开始渲染更新时，它将工作分解成多个小任务。每个任务都有自己的截止时间（deadline），React会在浏览器空闲时处理这些小任务，如果在截止时间之前任务还没有完成，React会将控制权交还给浏览器，以便浏览器可以处理更高优先级的工作（如用户输入响应），然后在浏览器再次空闲时，React会继续之前的工作。

这种机制允许React可以在渲染组件时“暂停”工作，然后在浏览器有空闲时间时“继续”工作，这样就不会阻塞主线程，从而提高应用程序的响应性和性能。

requestIdleCallback API允许开发者指定一个回调函数，在浏览器的空闲周期调用。React 实现时间分片的方式是通过在空闲周期内，分批次执行渲染更新任务，从而实现对任务的管理和调度。如果浏览器不支持 requestIdleCallback，React 会回退到使用 setTimeout 来模拟相同的行为。

#### 并发模式

并发模式允许 React 在后台执行多个任务，以实现对用户操作的更快响应。

总之，Fiber 是 React 的一种新算法，旨在通过对任务的分解和优先级调度，提高应用程序的性能和响应性。它为 React 带来了更好的渲染策略和新的开发特性。
