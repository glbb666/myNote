# JavaScript çš„äº‹ä»¶å¾ªç¯

 <https://github.com/Advanced-Frontend/Daily-Interview-Question/issues/7>

[ä»æµè§ˆå™¨å¤šè¿›ç¨‹åˆ°JSå•çº¿ç¨‹ï¼ŒJSè¿è¡Œæœºåˆ¶æœ€å…¨é¢çš„ä¸€æ¬¡æ¢³ç†](https://juejin.im/post/5a6547d0f265da3e283a1df7#heading-8)

æµè§ˆå™¨æ˜¯å¤šè¿›ç¨‹çš„ï¼Œå…¶ä¸­ï¼Œæµè§ˆå™¨å†…æ ¸å°±æ˜¯æµè§ˆå™¨æ¸²æŸ“è¿›ç¨‹ï¼Œæµè§ˆå™¨å†…æ ¸æ˜¯å¤šçº¿ç¨‹çš„ï¼Œå®ƒåŒ…æ‹¬ä»¥ä¸‹çº¿ç¨‹

- `GUI`æ¸²æŸ“çº¿ç¨‹ï¼šè´Ÿè´£æ¸²æŸ“æµè§ˆå™¨ç•Œé¢
- `JS`å¼•æ“çº¿ç¨‹ï¼šæ‰§è¡Œè§£ææ‰§è¡Œ`JS`è„šæœ¬

å®ƒä»¬ä¿©æ˜¯äº’æ–¥çš„ï¼ˆ`JS`å¯æ“ä½œ`DOM`ï¼Œè¾¹ä¿®æ”¹è¾¹æ¸²æŸ“ä¼šé€ æˆå…ƒç´ æ•°æ®ä¸ä¸€è‡´ï¼‰`JS`å¼•æ“æ‰§è¡Œæ—¶`GUI`ä¼šè¢«æŒ‚èµ·ï¼Œ`GUI`æ›´æ–°ä¼šè¢«ä¿å­˜åˆ°ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç­‰åˆ°`JS`å¼•æ“ç©ºé—²æ—¶å†è¢«æ‰§è¡Œã€‚æ‰€ä»¥å¦‚æœ`JS`æ‰§è¡Œçš„æ—¶é—´è¿‡é•¿ï¼ˆå¯åˆ›å»ºä¸€ä¸ª`worker`å­çº¿ç¨‹ï¼Œè®¡ç®—å‡ºç»“æœå†`postMessage`ç»™ä¸»çº¿ç¨‹ï¼‰ï¼Œå°±ä¼šé€ æˆé¡µé¢çš„æ¸²æŸ“ä¸è¿è´¯ï¼Œå¯¼è‡´é¡µé¢åŠ è½½é˜»å¡ã€‚

- äº‹ä»¶è§¦å‘çº¿ç¨‹ï¼šç”¨æ¥æ§åˆ¶äº‹ä»¶å¾ªç¯ï¼Œå½“äº‹ä»¶çš„ç¬¦åˆè§¦å‘æ¡ä»¶è¢«è§¦å‘æ—¶ï¼Œè¯¥çº¿ç¨‹ä¼šæŠŠè¯¥äº‹ä»¶æ·»åŠ åˆ°å®ä»»åŠ¡é˜Ÿåˆ—çš„é˜Ÿå°¾ï¼Œç­‰å¾…`JS`å¼•æ“çš„å¤„ç†ã€‚
- å®šæ—¶å™¨è§¦å‘çº¿ç¨‹ï¼š`setInterval`å’Œ`setTimeout`æ‰€åœ¨çº¿ç¨‹ï¼Œå¯¹å®šæ—¶å™¨è®¡æ—¶å¹¶è§¦å‘å®šæ—¶ï¼Œè®¡æ—¶å®Œæ¯•ï¼Œä¼šè¢«äº‹ä»¶è§¦å‘çº¿ç¨‹æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—çš„é˜Ÿå°¾ã€‚

ğŸŒŸæ³¨æ„ï¼š`W3C`åœ¨`HTML`æ ‡å‡†ä¸­è§„å®šï¼Œ`setTimeout`ä¸­ä½äº`4ms`çš„æ—¶é—´é—´éš”ç®—ä¸º`4ms`ã€‚

- å¼‚æ­¥`http`è¯·æ±‚çº¿ç¨‹ï¼šåœ¨`XMLHttpRequest`è¿æ¥åï¼Œé€šè¿‡æµè§ˆå™¨æ–°å¼€ä¸€ä¸ªçº¿ç¨‹è¯·æ±‚ï¼Œåœ¨æ£€æµ‹åˆ°çŠ¶æ€å˜æ›´æ—¶ï¼Œè§¦å‘çŠ¶æ€å˜æ›´äº‹ä»¶ï¼Œäº‹ä»¶è§¦å‘çº¿ç¨‹ä¼šå°†äº‹ä»¶çš„å›è°ƒæ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—çš„é˜Ÿå°¾ã€‚

## ä»»åŠ¡é˜Ÿåˆ—

é¦–å…ˆæˆ‘ä»¬éœ€è¦æ˜ç™½ä»¥ä¸‹å‡ ä»¶äº‹æƒ…ï¼š

- `JS`åˆ†ä¸ºåŒæ­¥ä»»åŠ¡å’Œå¼‚æ­¥ä»»åŠ¡
- åŒæ­¥ä»»åŠ¡éƒ½åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå½¢æˆä¸€ä¸ª**æ‰§è¡Œæ ˆ**
- ä¸»çº¿ç¨‹ä¹‹å¤–ï¼Œ**äº‹ä»¶è§¦å‘çº¿ç¨‹**ç®¡ç†ç€ä¸€ä¸ª**ä»»åŠ¡é˜Ÿåˆ—**ï¼Œåªè¦å¼‚æ­¥ä»»åŠ¡æœ‰äº†è¿è¡Œç»“æœï¼Œå°±åœ¨ä»»åŠ¡é˜Ÿåˆ—ä¹‹ä¸­æ”¾ç½®ä¸€ä¸ªäº‹ä»¶ã€‚
- ä¸€æ—¦**æ‰§è¡Œæ ˆ**ä¸­çš„æ‰€æœ‰åŒæ­¥ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼ˆæ­¤æ—¶`JS`å¼•æ“ç©ºé—²ï¼‰ï¼Œç³»ç»Ÿå°±ä¼šè¯»å–**ä»»åŠ¡é˜Ÿåˆ—**ï¼Œå°†å¯è¿è¡Œçš„å¼‚æ­¥ä»»åŠ¡æ·»åŠ åˆ°å¯æ‰§è¡Œæ ˆä¸­ï¼Œå¼€å§‹æ‰§è¡Œã€‚

äº‹ä»¶å¾ªç¯æ˜¯é€šè¿‡[ä»»åŠ¡é˜Ÿåˆ—](https://www.w3.org/TR/html5/webappapis.html#task-queues)çš„æœºåˆ¶æ¥è¿›è¡Œåè°ƒçš„ã€‚ä¸€ä¸ªäº‹ä»¶å¾ªç¯ä¸­ï¼Œå¯ä»¥æœ‰ä¸€ä¸ªæˆ–è€…å¤šä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ä¾¿æ˜¯ä¸€ç³»åˆ—æœ‰åºä»»åŠ¡çš„é›†åˆï¼›**æ¯ä¸ªä»»åŠ¡éƒ½æœ‰ä¸€ä¸ªä»»åŠ¡æºï¼Œæºè‡ªåŒä¸€ä¸ªä»»åŠ¡æºçš„ä»»åŠ¡å¿…é¡»æ”¾åˆ°åŒä¸€ä¸ªä»»åŠ¡é˜Ÿåˆ—ï¼Œä»ä¸åŒæºæ¥çš„åˆ™è¢«æ·»åŠ åˆ°ä¸åŒé˜Ÿåˆ—ã€‚** `setTimeout`/`Promise` ç­‰`API`ä¾¿æ˜¯ä»»åŠ¡æºï¼Œè€Œè¿›å…¥ä»»åŠ¡é˜Ÿåˆ—çš„æ˜¯ä»–ä»¬æŒ‡å®šçš„å…·ä½“æ‰§è¡Œä»»åŠ¡ã€‚

## `setTimeout`å’Œ`setInterval`çš„åŒºåˆ«

å› ä¸ºæ¯æ¬¡`setTimeout`è®¡æ—¶åˆ°åå°±ä¼šå»æ‰§è¡Œï¼Œç„¶åæ‰§è¡Œä¸€æ®µæ—¶é—´åæ‰ä¼šç»§ç»­`setTimeout`ï¼Œä¸­é—´å°±å¤šäº†è¯¯å·®(è¯¯å·®å¤šå°‘ä¸ä»£ç æ‰§è¡Œæ—¶é—´æœ‰å…³ï¼‰

`setInterval`åˆ™æ˜¯æ¯æ¬¡éƒ½ç²¾ç¡®çš„éš”ä¸€æ®µæ—¶é—´æ¨å…¥ä¸€ä¸ªäº‹ä»¶ï¼Œå¦‚æœå½“å‰äº‹ä»¶é˜Ÿåˆ—ä¸­æœ‰`setInterval`çš„å›è°ƒï¼Œä¸ä¼šé‡å¤æ·»åŠ ã€‚

## å®ä»»åŠ¡`macrotask`

æ¯æ¬¡æ‰§è¡Œæ ˆæ‰§è¡Œçš„ä»£ç å°±æ˜¯ä¸€ä¸ªå®ä»»åŠ¡ï¼ˆåŒ…æ‹¬æ¯æ¬¡ä»äº‹ä»¶é˜Ÿåˆ—ä¸­è·å–ä¸€ä¸ªäº‹ä»¶å›è°ƒå¹¶æ”¾åˆ°æ‰§è¡Œæ ˆä¸­æ‰§è¡Œï¼‰

- æ¯ä¸€ä¸ªå®ä»»åŠ¡éƒ½ä¼šä»å¤´åˆ°å°¾æ‰§è¡Œå®Œæ¯•ï¼Œä¸ä¼šæ‰§è¡Œå…¶ä»–
- æµè§ˆå™¨ä¸ºäº†èƒ½å¤Ÿä½¿å¾—`JS`å†…éƒ¨å®ä»»åŠ¡ä¸`DOM`ä»»åŠ¡èƒ½å¤Ÿæœ‰åºçš„æ‰§è¡Œï¼Œ**ä¼šåœ¨ä¸€ä¸ªå®ä»»åŠ¡æ‰§è¡Œç»“æŸåï¼Œä¸‹ä¸€ä¸ªå®ä»»åŠ¡æ‰§è¡Œå¼€å§‹å‰ï¼Œå¯¹é¡µé¢è¿›è¡Œé‡æ–°æ¸²æŸ“**ï¼ˆ`  å®ä»»åŠ¡->æ¸²æŸ“->å®ä»»åŠ¡->...`ï¼‰
- ç”±äº‹ä»¶è§¦å‘çº¿ç¨‹ç»´æŠ¤

å®ä»»åŠ¡ä¸»è¦åŒ…å«ï¼š`script(æ•´ä½“ä»£ç )`ã€`setTimeout`ã€`setInterval`ã€`I/O`ã€`UIäº¤äº’äº‹ä»¶`ã€`postMessage`ã€`MessageChannel`ã€`setImmediate(Node.js ç¯å¢ƒ)`

## å¾®ä»»åŠ¡`microtask`

**åœ¨å½“å‰ task æ‰§è¡Œç»“æŸåç«‹å³æ‰§è¡Œçš„ä»»åŠ¡**ã€‚ï¼ˆ`  å®ä»»åŠ¡->å¾®ä»»åŠ¡->æ¸²æŸ“->å®ä»»åŠ¡->...`ï¼‰

- å®ƒçš„å“åº”é€Ÿåº¦ç›¸æ¯”`setTimeout`ï¼ˆ`setTimeout`æ˜¯å®ä»»åŠ¡ï¼‰ä¼šæ›´å¿«ï¼Œå› ä¸ºæ— éœ€ç­‰æ¸²æŸ“ã€‚
- åœ¨æŸä¸€ä¸ª`macrotask`æ‰§è¡Œå®Œåï¼Œå°±ä¼šå°†åœ¨å®ƒæ‰§è¡ŒæœŸé—´äº§ç”Ÿçš„æ‰€æœ‰`microtask`éƒ½æ‰§è¡Œå®Œæ¯•ã€‚
- ç”±`js`å¼•æ“çº¿ç¨‹ç»´æŠ¤

`microtask`ä¸»è¦åŒ…å«ï¼š`Promise.then`ã€`MutaionObserver`ã€`process.nextTick`(`Node.js` ç¯å¢ƒ)

**è¡¥å……ï¼šåœ¨nodeç¯å¢ƒä¸‹ï¼Œ`process.nextTick`çš„ä¼˜å…ˆçº§é«˜äº`Promise`**ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥ç®€å•ç†è§£ä¸ºï¼šåœ¨å®ä»»åŠ¡ç»“æŸåä¼šå…ˆæ‰§è¡Œå¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„`nextTickQueue`éƒ¨åˆ†ï¼Œç„¶åæ‰ä¼šæ‰§è¡Œå¾®ä»»åŠ¡ä¸­çš„`Promise`éƒ¨åˆ†ã€‚

## è¿è¡Œæœºåˆ¶

åœ¨äº‹ä»¶å¾ªç¯ä¸­ï¼Œæ¯è¿›è¡Œä¸€æ¬¡å¾ªç¯æ“ä½œç§°ä¸º tick

- æ‰§è¡Œä¸€ä¸ªå®ä»»åŠ¡ï¼ˆæ ˆä¸­æ²¡æœ‰å°±ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ï¼‰
- æ‰§è¡Œè¿‡ç¨‹ä¸­å¦‚æœé‡åˆ°å¾®ä»»åŠ¡ï¼Œå°±å°†å®ƒæ·»åŠ åˆ°å¾®ä»»åŠ¡çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­
- å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•åï¼Œç«‹å³æ‰§è¡Œå½“å‰å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å¾®ä»»åŠ¡ï¼ˆä¾æ¬¡æ‰§è¡Œï¼‰
- å½“å‰å®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œå¼€å§‹æ£€æŸ¥æ¸²æŸ“ï¼Œç„¶åGUIçº¿ç¨‹æ¥ç®¡æ¸²æŸ“
- æ¸²æŸ“å®Œæ¯•åï¼ŒJSçº¿ç¨‹ç»§ç»­æ¥ç®¡ï¼Œå¼€å§‹ä¸‹ä¸€ä¸ªå®ä»»åŠ¡ï¼ˆä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ï¼‰

æµç¨‹å›¾å¦‚ä¸‹ï¼š

[![mark](images/68747470733a2f2f692e6c6f6c692e6e65742f323031392f30322f30382f356335643661353238626461662e6a7067.jpg)](https://camo.githubusercontent.com/47479c8773d91e8eef4a359eca57bb1361183b9e/68747470733a2f2f692e6c6f6c692e6e65742f323031392f30322f30382f356335643661353238626461662e6a7067)

## `Promise`å’Œ`async`ä¸­çš„ç«‹å³æ‰§è¡Œ

æˆ‘ä»¬çŸ¥é“`Promise`ä¸­çš„å¼‚æ­¥ä½“ç°åœ¨`then`å’Œ`catch`ä¸­ï¼Œæ‰€ä»¥å†™åœ¨`Promise`ä¸­çš„ä»£ç æ˜¯è¢«å½“åšåŒæ­¥ä»»åŠ¡ç«‹å³æ‰§è¡Œçš„ã€‚è€Œåœ¨`async/await`ä¸­ï¼Œåœ¨å‡ºç°`await`å‡ºç°ä¹‹å‰ï¼Œå…¶ä¸­çš„ä»£ç ä¹Ÿæ˜¯ç«‹å³æ‰§è¡Œçš„ã€‚é‚£ä¹ˆå‡ºç°äº†`await`æ—¶å€™å‘ç”Ÿäº†ä»€ä¹ˆå‘¢ï¼Ÿ

## awaitåšäº†ä»€ä¹ˆ

ä»å­—é¢æ„æ€ä¸Šçœ‹`await`å°±æ˜¯ç­‰å¾…ï¼Œ`await` ç­‰å¾…çš„æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè¿™ä¸ªè¡¨è¾¾å¼çš„è¿”å›å€¼å¯ä»¥æ˜¯ä¸€ä¸ª`promise`å¯¹è±¡ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–å€¼ã€‚

å¾ˆå¤šäººä»¥ä¸ºawaitä¼šä¸€ç›´ç­‰å¾…ä¹‹åçš„è¡¨è¾¾å¼æ‰§è¡Œå®Œä¹‹åæ‰ä¼šç»§ç»­æ‰§è¡Œåé¢çš„ä»£ç ï¼Œ**å®é™…ä¸Š`await`æ˜¯ä¸€ä¸ªè®©å‡ºçº¿ç¨‹çš„æ ‡å¿—ã€‚`await`åé¢çš„è¡¨è¾¾å¼ä¼šå…ˆæ‰§è¡Œä¸€éï¼Œå°†`await`åé¢çš„ä»£ç åŠ å…¥åˆ°`microtask`ä¸­ï¼Œç„¶åå°±ä¼šè·³å‡ºæ•´ä¸ª`async`å‡½æ•°æ¥æ‰§è¡Œåé¢çš„ä»£ç ã€‚**

ç”±äºå› ä¸º`async await` æ˜¯`generator`çš„è¯­æ³•ç³–ã€‚æ‰€ä»¥`await`åé¢çš„ä»£ç æ˜¯å¾®ä»»åŠ¡ã€‚æ‰€ä»¥å¯¹äºæœ¬é¢˜ä¸­çš„

```javascript
async function async1() {
	console.log('async1 start');
	await async2();
	console.log('async1 end');
}
```

ç­‰ä»·äº

```javascript
async function async1() {
	console.log('async1 start');
	Promise.resolve(async2()).then(() =>{
                console.log('async1 end');
        })
}
```

## å›åˆ°æœ¬é¢˜

```javascript
//è¯·å†™å‡ºè¾“å‡ºå†…å®¹
async function async1() {
    console.log('async1 start');//2
    await async2();//3 awaitåé¢çš„è¡¨è¾¾å¼ä¼šå…ˆæ‰§è¡Œä¸€éï¼Œå°†awaitåé¢çš„ä»£ç åŠ å…¥åˆ°microtaskä¸­
    console.log('async1 end');//6
}
async function async2() {
	console.log('async2');
}

console.log('script start');  // 1

setTimeout(function() {
    console.log('setTimeout');//8
}, 0)

async1();

new Promise(function(resolve) {
    console.log('promise1');//4
    resolve();
}).then(function() {
    console.log('promise2');//7
});
console.log('script end');//5

/*
script start
async1 start
async2
promise1
script end
async1 end
promise2
setTimeout
*/
```

è¿™é“é¢˜ä¸»è¦è€ƒå¯Ÿçš„æ˜¯äº‹ä»¶å¾ªç¯ä¸­å‡½æ•°æ‰§è¡Œé¡ºåºçš„é—®é¢˜ï¼Œå…¶ä¸­åŒ…æ‹¬`async` ï¼Œ`await`ï¼Œ`setTimeout`ï¼Œ`Promise`å‡½æ•°ã€‚ä¸‹é¢æ¥è¯´ä¸€ä¸‹æœ¬é¢˜ä¸­æ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹ã€‚

ä»¥ä¸Šå°±æœ¬é“é¢˜æ¶‰åŠåˆ°çš„æ‰€æœ‰ç›¸å…³çŸ¥è¯†ç‚¹äº†ï¼Œä¸‹é¢æˆ‘ä»¬å†å›åˆ°è¿™é“é¢˜æ¥ä¸€æ­¥ä¸€æ­¥çœ‹çœ‹æ€ä¹ˆå›äº‹å„¿ã€‚

1. é¦–å…ˆï¼Œäº‹ä»¶å¾ªç¯ä»å®ä»»åŠ¡é˜Ÿåˆ—å¼€å§‹ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œåªæœ‰ä¸€ä¸ªscript(æ•´ä½“ä»£ç )ä»»åŠ¡ï¼›å½“é‡åˆ°ä»»åŠ¡æº(task source)æ—¶ï¼Œåˆ™ä¼šå…ˆåˆ†å‘ä»»åŠ¡åˆ°å¯¹åº”çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­å»ã€‚æ‰€ä»¥ï¼Œä¸Šé¢ä¾‹å­çš„ç¬¬ä¸€æ­¥æ‰§è¡Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

   [![img](images/68747470733a2f2f692e6c6f6c692e6e65742f323031392f30322f30382f356335643639623432316166332e706e67.png)](https://camo.githubusercontent.com/15b3ae9733b0b5b6a144f519396ff88eaeca40fb/68747470733a2f2f692e6c6f6c692e6e65742f323031392f30322f30382f356335643639623432316166332e706e67)

2. ç„¶åæˆ‘ä»¬çœ‹åˆ°é¦–å…ˆå®šä¹‰äº†ä¸¤ä¸ª`async`å‡½æ•°ï¼Œæ¥ç€å¾€ä¸‹çœ‹ï¼Œç„¶åé‡åˆ°äº† `console` è¯­å¥ï¼Œç›´æ¥è¾“å‡º `script start`ã€‚è¾“å‡ºä¹‹åï¼Œscript ä»»åŠ¡ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œé‡åˆ° `setTimeout`ï¼Œå…¶ä½œä¸ºä¸€ä¸ªå®ä»»åŠ¡æºï¼Œåˆ™ä¼šå…ˆå°†å…¶ä»»åŠ¡åˆ†å‘åˆ°å¯¹åº”çš„é˜Ÿåˆ—ä¸­ï¼š
   [![img](images/68747470733a2f2f692e6c6f6c692e6e65742f323031392f30322f30382f356335643639623432353530612e706e67.png)](https://camo.githubusercontent.com/0a6e6cd2cc52d18a0f97ec01659058e830305a45/68747470733a2f2f692e6c6f6c692e6e65742f323031392f30322f30382f356335643639623432353530612e706e67)

3. script ä»»åŠ¡ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œæ‰§è¡Œäº†async1()å‡½æ•°ï¼Œå‰é¢è®²è¿‡asyncå‡½æ•°ä¸­åœ¨awaitä¹‹å‰çš„ä»£ç æ˜¯ç«‹å³æ‰§è¡Œçš„ï¼Œæ‰€ä»¥ä¼šç«‹å³è¾“å‡º`async1 start`ã€‚
   é‡åˆ°äº†awaitæ—¶ï¼Œä¼šå°†awaitåé¢çš„è¡¨è¾¾å¼æ‰§è¡Œä¸€éï¼Œæ‰€ä»¥å°±ç´§æ¥ç€è¾“å‡º`async2`ï¼Œç„¶åå°†awaitåé¢çš„ä»£ç ä¹Ÿå°±æ˜¯`console.log('async1 end')`åŠ å…¥åˆ°microtaskä¸­çš„Promiseé˜Ÿåˆ—ä¸­ï¼Œæ¥ç€è·³å‡ºasync1å‡½æ•°æ¥æ‰§è¡Œåé¢çš„ä»£ç ã€‚
   [![img](images/68747470733a2f2f692e6c6f6c692e6e65742f323031392f30322f31382f356336616435383333376165642e706e67.png)](https://camo.githubusercontent.com/93ec5469b0846f0f161641fc718005dbe994d190/68747470733a2f2f692e6c6f6c692e6e65742f323031392f30322f31382f356336616435383333376165642e706e67)

4. scriptä»»åŠ¡ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œé‡åˆ°Promiseå®ä¾‹ã€‚ç”±äºPromiseä¸­çš„å‡½æ•°æ˜¯ç«‹å³æ‰§è¡Œçš„ï¼Œè€Œåç»­çš„ `.then` åˆ™ä¼šè¢«åˆ†å‘åˆ° `microtask` çš„ `Promise` é˜Ÿåˆ—ä¸­å»ã€‚æ‰€ä»¥ä¼šå…ˆè¾“å‡º `promise1`ï¼Œç„¶åæ‰§è¡Œ `resolve`ï¼Œå°† `promise2` åˆ†é…åˆ°å¯¹åº”é˜Ÿåˆ—ã€‚
   [![img](images/68747470733a2f2f692e6c6f6c692e6e65742f323031392f30322f31382f356336616435383334376135652e706e67.png)](https://camo.githubusercontent.com/6f617a237607ce7a71fabcab61d2952a8b412205/68747470733a2f2f692e6c6f6c692e6e65742f323031392f30322f31382f356336616435383334376135652e706e67)

5. scriptä»»åŠ¡ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œæœ€ååªæœ‰ä¸€å¥è¾“å‡ºäº† `script end`ï¼Œè‡³æ­¤ï¼Œå…¨å±€ä»»åŠ¡å°±æ‰§è¡Œå®Œæ¯•äº†ã€‚
   æ ¹æ®ä¸Šè¿°ï¼Œæ¯æ¬¡æ‰§è¡Œå®Œä¸€ä¸ªå®ä»»åŠ¡ä¹‹åï¼Œä¼šå»æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¾®ä»»åŠ¡ï¼›å¦‚æœæœ‰ï¼Œåˆ™æ‰§è¡Œå¾®ä»»åŠ¡ç›´è‡³æ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚
   å› è€Œåœ¨`script`ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œå¼€å§‹æŸ¥æ‰¾æ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚æ­¤æ—¶ï¼Œå¾®ä»»åŠ¡ä¸­ï¼Œ `Promise` é˜Ÿåˆ—æœ‰çš„ä¸¤ä¸ªä»»åŠ¡`async1 end`å’Œ`promise2`ï¼Œå› æ­¤æŒ‰å…ˆåé¡ºåºè¾“å‡º `async1 endï¼Œpromise2`ã€‚å½“æ‰€æœ‰çš„å¾®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œè¡¨ç¤ºç¬¬ä¸€è½®çš„å¾ªç¯å°±ç»“æŸäº†ã€‚

6. ç¬¬äºŒè½®å¾ªç¯å¼€å§‹ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šè·³å›`async1`å‡½æ•°ä¸­æ‰§è¡Œåé¢çš„ä»£ç ï¼Œç„¶åé‡åˆ°äº†åŒæ­¥ä»»åŠ¡ `console` è¯­å¥ï¼Œç›´æ¥è¾“å‡º `async1 end`ã€‚è¿™æ ·ç¬¬äºŒè½®çš„å¾ªç¯å°±ç»“æŸäº†ã€‚ï¼ˆä¹Ÿå¯ä»¥ç†è§£ä¸ºè¢«åŠ å…¥åˆ°`script`ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œæ‰€ä»¥ä¼šå…ˆä¸`setTimeout`é˜Ÿåˆ—æ‰§è¡Œï¼‰

7. ç¬¬äºŒè½®å¾ªç¯ä¾æ—§ä»å®ä»»åŠ¡é˜Ÿåˆ—å¼€å§‹ã€‚æ­¤æ—¶å®ä»»åŠ¡ä¸­åªæœ‰ä¸€ä¸ª `setTimeout`ï¼Œå–å‡ºç›´æ¥è¾“å‡ºå³å¯ï¼Œè‡³æ­¤æ•´ä¸ªæµç¨‹ç»“æŸã€‚

ä¸‹é¢æˆ‘ä¼šæ”¹å˜ä¸€ä¸‹ä»£ç æ¥åŠ æ·±å°è±¡ã€‚

## å˜å¼ä¸€

åœ¨ç¬¬ä¸€ä¸ªå˜å¼ä¸­æˆ‘å°†`async2`ä¸­çš„å‡½æ•°ä¹Ÿå˜æˆäº†`Promise`å‡½æ•°ï¼Œä»£ç å¦‚ä¸‹ï¼š

```javascript
async function async1() {
    console.log('async1 start');
    await async2();
    console.log('async1 end');
}
async function async2() {
    new Promise(function(resolve) {
    console.log('promise1');
    resolve();
}).then(function() {
    console.log('promise2');
    });
}
console.log('script start');
setTimeout(function() {
    console.log('setTimeout');
}, 0)
async1();

new Promise(function(resolve) {
    console.log('promise3');
    resolve();
}).then(function() {
    console.log('promise4');
});

console.log('script end');
```

å¯ä»¥å…ˆè‡ªå·±çœ‹çœ‹è¾“å‡ºé¡ºåºä¼šæ˜¯ä»€ä¹ˆï¼Œä¸‹é¢æ¥å…¬å¸ƒç»“æœï¼š

```
script start
async1 start
promise1
promise3
script end
promise2
async1 end
promise4
setTimeout
```

## å˜å¼äºŒ

åœ¨ç¬¬äºŒä¸ªå˜å¼ä¸­ï¼Œæˆ‘å°†async1ä¸­awaitåé¢çš„ä»£ç å’Œasync2çš„ä»£ç éƒ½æ”¹ä¸ºå¼‚æ­¥çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š

```javascript
async function async1() {
    console.log('async1 start');//2
    await async2();
    //æ›´æ”¹å¦‚ä¸‹ï¼š
    setTimeout(function() {
        console.log('setTimeout1')//å®3
    },0)
}
async function async2() {
    //æ›´æ”¹å¦‚ä¸‹ï¼š
	setTimeout(function() {
		console.log('setTimeout2')//å®2
	},0)
}
console.log('script start');//1

setTimeout(function() {
    console.log('setTimeout3');//å®1
}, 0)
async1();

new Promise(function(resolve) {
    console.log('promise1');//3
    resolve();
}).then(function() {
    console.log('promise2');//å¾®1
});
console.log('script end');//4
```

å¯ä»¥å…ˆè‡ªå·±çœ‹çœ‹è¾“å‡ºé¡ºåºä¼šæ˜¯ä»€ä¹ˆï¼Œä¸‹é¢æ¥å…¬å¸ƒç»“æœï¼š

```
script start
async1 start
promise1
script end
promise2
setTimeout3
setTimeout2
setTimeout1
```

## å˜å¼ä¸‰

å˜å¼ä¸‰æ˜¯æˆ‘åœ¨ä¸€ç¯‡é¢ç»ä¸­çœ‹åˆ°çš„åŸé¢˜ï¼Œæ•´ä½“æ¥è¯´å¤§åŒå°å¼‚ï¼Œä»£ç å¦‚ä¸‹ï¼š

```javascript
async function a1 () {
    console.log('a1 start')//2
    await a2()
    console.log('a1 end')//å¾®2
}
async function a2 () {
    console.log('a2')//3
}

console.log('script start')//1

setTimeout(() =>{
    console.log('setTimeout')//å®1
}, 0)

Promise.resolve().then(() =>{
    console.log('promise1')//å¾®1
})

a1()

let promise2 = new Promise((resolve) =>{
    resolve('promise2.then')
    console.log('promise2')//4
})

promise2.then((res) =>{
    console.log(res)//å¾®3
    Promise.resolve().then(() =>{
        console.log('promise3')//å¾®4
    })
})
console.log('script end')//5
```

æ— éæ˜¯åœ¨å¾®ä»»åŠ¡é‚£å—å„¿åšç‚¹æ–‡ç« ï¼Œå‰é¢çš„å†…å®¹å¦‚æœä½ éƒ½çœ‹æ‡‚äº†çš„è¯è¿™é“é¢˜ä¸€å®šæ²¡é—®é¢˜çš„ï¼Œç»“æœå¦‚ä¸‹ï¼š

```
script start
a1 start
a2
promise2
script end
promise1
a1 end
promise2.then
promise3
setTimeout
```

### æ€»ç»“

äº‹ä»¶å¾ªç¯æœºåˆ¶è¦ç‚¹ï¼š

- å®ä»»åŠ¡ï¼š`script`ã€`setTimeout`ã€`setTimeInterval`ã€`I/O`ã€`postMessage`ã€`setImmediate(node)`
- å¾®ä»»åŠ¡ï¼š`promise.then`ã€`process.nextTick`ã€`await`åé¢çš„ä»£ç 
- `promise`å’Œ`async`åçš„è¡¨è¾¾å¼ç«‹å³æ‰§è¡Œ
- `await`æœºåˆ¶ï¼šè®©å‡ºçº¿ç¨‹ï¼Œæ‰§è¡Œå…³é”®å­—åé¢çš„è¡¨è¾¾å¼ï¼Œè€Œawaitåé¢çš„ä»£ç åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚