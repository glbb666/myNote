### å­—ç¬¦åˆ¤æ–­

åˆ¤æ–­ä¸€ä¸ªå­—ç¬¦æ˜¯ä¸æ˜¯æ¢è¡Œç¬¦

```typescript
export function isLineBreak(ch: number): boolean {
    return ch === CharacterCodes.lineFeed ||
        ch === CharacterCodes.carriageReturn ||
        ch === CharacterCodes.lineSeparator ||
        ch === CharacterCodes.paragraphSeparator;
}
```

### tsè®¡ç®—è¡Œåˆ—å·å’Œç´¢å¼•

#### å‰ç½®çŸ¥è¯†

è¡Œç»ˆæ­¢ç¬¦è¡¨

|      | ä¸­æ–‡                 | è‹±æ–‡               | è‹±æ–‡ç®€ç§° | Unicodeç¼–ç  |
| ---- | -------------------- | ------------------ | -------- | ----------- |
| \n   | æ¢è¡Œ                 | lineFeed           | <LF>     | 0x0A        |
| \r   | å›è½¦ï¼ˆæ“ä½œåœ¨å½“å‰è¡Œï¼‰ | carriageReturn     | <CR>     | 0x0D        |
|      | è¡Œåˆ†å‰²ç¬¦             | lineSeparator      | <LS>     | 0x2028      |
|      | æ®µè½åˆ†å‰²ç¬¦           | paragraphSeparator | <PS>     | 0x2029      |

åªæœ‰ä¸Šè¡¨ä¸­çš„å­—ç¬¦è¢«è§†ä¸ºè¡Œç»ˆæ­¢ç¬¦ã€‚å…¶ä»–æ¢è¡Œç¬¦æˆ–æ¢è¡Œç¬¦è¢«è§†ä¸ºç©ºæ ¼è€Œä¸æ˜¯è¡Œç»ˆæ­¢ç¬¦ã€‚

åœ¨ä¸åŒçš„ç³»ç»Ÿä¸­ï¼Œæ¯è¡Œç»“å°¾ä½¿ç”¨çš„æ¢è¡Œç¬¦æ˜¯ä¸ä¸€æ ·çš„

| Unix | Windows | Mac  |
| ---- | ------- | ---- |
| \n   | \r\n    | \r   |

é¦–å…ˆè®¡ç®—æ¯è¡Œç¬¬ä¸€ä¸ªå­—ç¬¦çš„ç´¢å¼•è¡¨ï¼š

```typescript
/* @internal */
export function computeLineStarts(text: string): number[] {
    const result: number[] = new Array();
    let pos = 0;
    let lineStart = 0;
    while (pos < text.length) {
        const ch = text.charCodeAt(pos);
        pos++;
        switch (ch) {
            case CharacterCodes.carriageReturn://\r
                if (text.charCodeAt(pos) === CharacterCodes.lineFeed) {
                    pos++;
                }
            case CharacterCodes.lineFeed://\n
                result.push(lineStart);
                lineStart = pos;
                break;
            default:
            		// maxAsciiCharacter = 0x7F
            		// è¡Œåˆ†å‰²ç¬¦å’Œæ®µè½åˆ†å‰²ç¬¦
                if (ch > CharacterCodes.maxAsciiCharacter && isLineBreak(ch)) {
                    result.push(lineStart);
                    lineStart = pos;
                }
                break;
        }
    }
    result.push(lineStart);
    return result;
}

```

è¿™æ®µä»£ç çš„æ ¸å¿ƒéƒ¨åˆ†æ˜¯switchéƒ¨åˆ†

- å½“`ch`ä¸º`\r`,`\n`,`\r`ååŠ `\n`æˆ–è€…æ˜¯è¡Œåˆ†å‰²ç¬¦å’Œæ®µè½åˆ†å‰²ç¬¦

  éƒ½è¯´æ˜åˆ°äº†è¡Œçš„æœ«å°¾

  æ­¤åˆ»éƒ½ä¼šæ‰§è¡Œè¿™ä¸¤è¡Œä»£ç 

  ```typescript
  result.push(lineStart);
  lineStart = pos;
  ```

  æŠŠä¸Šæ¬¡çš„é¦–è¡Œå­˜å…¥`result`æ•°ç»„ï¼Œè®©`lineStart`æŒ‡å‘æœ¬æ¬¡çš„é¦–è¡Œ

- å½“`ch`ä¸ºéè¡Œç»ˆæ­¢ç¬¦ï¼Œåˆ™ç»§ç»­å¾€åå¯»æ‰¾è¡Œç»ˆæ­¢ç¬¦

ç›®å‰ï¼Œæˆ‘ä»¬å·²ç»è®¡ç®—äº†é¦–è¡Œå­—æ¯çš„ç´¢å¼•è¡¨

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ£€ç´¢ç´¢å¼•è¡¨ï¼Œæ ¹æ®`position`æŸ¥è¯¢è¡Œåˆ—å·äº†

```typescript
/* @internal */
/**
 * We assume the first line starts at position 0 and 'position' is non-negative.
 */
export function computeLineAndCharacterOfPosition(lineStarts: readonly number[], position: number): LineAndCharacter {
    let lineNumber = binarySearch(lineStarts, position, identity, compareValues);
    if (lineNumber < 0) {
        // If the actual position was not found,
        // the binary search returns the 2's-complement of the next line start
        // e.g. if the line starts at [5, 10, 23, 80] and the position requested was 20
        // then the search will return -2.
        //
        // We want the index of the previous line start, so we subtract 1.
        // Review 2's-complement if this is confusing.
        lineNumber = ~lineNumber - 1;
        Debug.assert(lineNumber !== -1, "position cannot precede the beginning of the file");
    }
    return {
        line: lineNumber,
        character: position - lineStarts[lineNumber]
    };
}
```

  ### æ ‡è®°

ç»è¿‡ä¸Šè¿°ï¼Œæˆ‘ä»¬å·²ç»æ‹¥æœ‰äº†å¯¹å•ä¸ªå­—ç¬¦åˆ†æçš„èƒ½åŠ›

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç”¨å­—ç¬¦ç»„è£…æ ‡è®°

æ ‡è®°å¯ä»¥æ˜¯ä¸€ä¸ªå˜é‡åã€ä¸€ä¸ªç¬¦å·æˆ–ä¸€ä¸ªå…³é”®å­—ã€‚

 å¯¹äº

```typescript
var x = String.fromCharCode(100); 
```

ä¸€å…±å¯è§£æå‡ºä»¥ä¸‹æ ‡è®°ï¼š

1. var å…³é”®å­—æ ‡è®°
2. æ ‡è¯†ç¬¦æ ‡è®°(å†…å®¹æ˜¯ x)
3. ç­‰å·æ ‡è®°(=)
4. æ ‡è¯†ç¬¦æ ‡è®°(å†…å®¹æ˜¯ String)
5. ç‚¹æ ‡è®°(.)
6. æ ‡è¯†ç¬¦æ ‡è®°(å†…å®¹æ˜¯ fromCharCode)
7. å·¦æ‹¬å·æ ‡è®°(()
8. æ•°å­—æ ‡è®°(å†…å®¹æ˜¯ 100)
9. å³æ‹¬å·æ ‡è®°())
10. åˆ†å·æ ‡è®°(;)

è¿™ä¸ªè¿‡ç¨‹ä¸­å­˜åœ¨ä¸¤ä¸ªä¸ªé—®é¢˜

#### åœ¨ä»€ä¹ˆæƒ…å†µä¸‹ï¼Œå­—ç¬¦ä¼šå½¢æˆæ ‡è®°å‘¢ï¼Ÿ

å½“æŸå‡ ä¸ªå­—ç¬¦æ˜¯ä¸å¯åˆ†å‰²ï¼Œå¯ä»¥å½¢æˆä¸€ä¸ªæ•´ä½“çš„æ—¶å€™ï¼Œä¼šå½¢æˆæ ‡è®°ã€‚

ğŸŒ°æ¯”å¦‚ä»£ç  0.1.toString ä¸­ï¼ŒåŒ…å«ä»¥ä¸‹æ ‡è®°ï¼š

1. æ•°å­—æ ‡è®°(0.1)
2. ç‚¹æ ‡è®°(.)
3. æ ‡è¯†ç¬¦æ ‡è®°(å†…å®¹æ˜¯ toString)

#### æˆ‘ä»¬æ€ä¹ˆå»æŠŠå­—ç¬¦è¯†åˆ«æˆæ ‡è®°å‘¢ï¼Ÿ

è¦å›ç­”è¿™ä¸ªé—®é¢˜â€”â€”

é¦–å…ˆï¼Œæˆ‘ä»¬è¦åŒºåˆ†å…³é”®è¯å’Œæ™®é€šçš„æ ‡è¯†ç¬¦ã€‚**å…³é”®å­—æœ‰ç‰¹æ®Šçš„æ ‡è®°ç±»å‹ï¼Œè€Œå…¶å®ƒå•è¯ç»Ÿç§°ä¸ºæ ‡è¯†ç¬¦**ï¼Œè¿™åˆæ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

- ä¸»è¦ä¸ºäº†æ–¹ä¾¿åç»­è§£æï¼Œä¹‹ååˆ¤æ–­å•è¯æ˜¯å¦æ˜¯å…³é”®å­—æ—¶ï¼Œåªéœ€åˆ¤æ–­æ ‡è®°ç±»å‹ï¼Œè€Œä¸æ˜¯å¾ˆéº»çƒ¦åœ°å…ˆåˆ¤æ–­æ˜¯å¦æ˜¯æ ‡è¯†ç¬¦å†åˆ¤æ–­æ ‡è¯†ç¬¦çš„å†…å®¹ã€‚

æ¥ç€ï¼Œæˆ‘ä»¬éœ€è¦äº†è§£è§£æçš„æµç¨‹

æ¯ä¸ªæ ‡è®°åœ¨æºç ä¸­éƒ½æœ‰å›ºå®šçš„ä½ç½®ï¼Œå¦‚æœå°†æºç çœ‹æˆå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆè¿™ä¸ª**æ ‡è®°ç¬¬ä¸€ä¸ªå­—ç¬¦åœ¨å­—ç¬¦ä¸²ä¸­çš„ç´¢å¼•å°±æ˜¯æ ‡è®°çš„å¼€å§‹ä½ç½®ï¼Œæœ€åä¸€ä¸ªå­—ç¬¦å¯¹åº”çš„å°±æ˜¯ç»“æŸä½ç½®**ã€‚

åœ¨è§£ææ¯ä¸ªæ ‡è®°æ—¶ï¼Œä¼šè·³è¿‡æ ‡è®°ä¹‹é—´çš„ç©ºæ ¼ã€æ³¨é‡Šã€‚å¦‚æœæŠŠæ¯ä¸ªæ ‡è®°ä¹‹å‰ã€ä¸Šä¸€ä¸ªæ ‡è®°ä¹‹åçš„ç©ºæ ¼ã€æ³¨é‡ŠåŒ…æ‹¬è¿›æ¥ï¼Œè¿™ä¸ªæ ‡è®°çš„ä½ç½®å³æ ‡è®°çš„å®Œæ•´å¼€å§‹ä½ç½®ã€‚ä¸€ä¸ªæ ‡è®°çš„å®Œæ•´å¼€å§‹ä½ç½®ç­‰åŒäºä¸Šä¸€ä¸ªæ ‡è®°çš„ç»“æŸä½ç½®ã€‚

![img](https://img2018.cnblogs.com/blog/158732/202001/158732-20200118220605127-2072378166.png)

 

ç»¼ä¸Šï¼Œä»»ä½•æºç éƒ½å¯ä»¥è¢«è§£ææˆä¸€ä¸²`token`ç»„æˆçš„æ•°ç»„ï¼Œæ¯ä¸ª`token`éƒ½æ˜¯æœ‰ä»¥ä¸‹å±æ€§çš„å¯¹è±¡ï¼š

- æ ‡è®°çš„ç±»å‹ï¼ˆåŒºåˆ†è¿™æ˜¯å…³é”®å­—ã€è¿˜æ˜¯æ ‡è¯†ç¬¦ã€è¿˜æ˜¯å…¶å®ƒçš„ç¬¦å·ï¼‰
- æ ‡è®°çš„å†…å®¹ï¼ˆé’ˆå¯¹æ ‡è¯†ç¬¦ã€å­—ç¬¦ä¸²ã€æ•°å­—ç­‰æ ‡è®°ç±»å‹ï¼Œè·å–å…¶çœŸå®çš„å†…å®¹ï¼‰
- æ ‡è®°çš„å¼€å§‹ä½ç½®
- æ ‡è®°çš„ç»“æŸä½ç½®
- æ ‡è®°çš„å®Œæ•´å¼€å§‹ä½ç½®

åœ¨ TS æºç ä¸­ï¼Œç”¨ SyntaxKind æšä¸¾åˆ—å‡ºäº†æ‰€æœ‰æ ‡è®°ç±»å‹ï¼š

```typescript
export const enum SyntaxKind {
    CloseBraceToken,
    OpenParenToken,
    CloseParenToken,
    OpenBracketToken,
    // ...(ç•¥)
}
```

é‚£ä¹ˆè§£æçš„æµç¨‹ï¼Œæ˜¯è°å»åšå‘¢â€”â€”æ˜¯æ‰«æå™¨

### æ‰«æå™¨ï¼ˆScannerï¼‰

ä¸€ä»½ä»£ç ä¸­ï¼Œä¸€èˆ¬ä¼šè§£æå‡ºä¸Šåƒä¸ªæ ‡è®°ã€‚å¦‚æœå°†æ¯ä¸ªæ ‡è®°éƒ½å­˜ä¸‹æ¥å°±ä¼šæ¶ˆè€—å¤§é‡çš„å†…å­˜ï¼Œè€Œå°±åƒä½ è¯»æ–‡ç« æ—¶ï¼Œä½ åªè¦ç›¯ç€å½“å‰æ­£åœ¨è¯»çš„è¿™å‡ è¡Œå­—ï¼Œè€Œä¸éœ€è¦å°†å…¨æ–‡çš„å­—éƒ½è®°ä¸‹æ¥ä¸€æ ·ï¼Œè§£æä»£ç æ—¶ï¼Œä¹Ÿåªéœ€è¦çŸ¥é“å½“å‰æ­£åœ¨è¯»çš„æ ‡è®°ï¼Œä¹‹å‰å·²ç»ç†è§£è¿‡çš„æ ‡è®°ä¸éœ€è¦å†è®°ä¸‹æ¥ã€‚æ‰€ä»¥å®è·µä¸Šå‡ºäºæ€§èƒ½è€ƒè™‘ï¼Œé‡‡ç”¨æ‰«æçš„æ–¹å¼é€ä¸ªè¯»å–æ ‡è®°ï¼Œè€Œä¸æ˜¯ä¸€å£æ°”å°†æ‰€æœ‰æ ‡è®°å…ˆè¯»å‡ºæ¥æ”¾åœ¨æ•°ç»„é‡Œã€‚

ä»€ä¹ˆæ˜¯æ‰«æçš„æ–¹å¼ï¼Ÿå³æœ‰ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæ¯è°ƒç”¨ä¸€æ¬¡æ‰«æå‡½æ•°(scan())ï¼Œè¿™ä¸ªå˜é‡çš„å€¼å°±ä¼šè¢«æ›´æ–°ä¸ºä¸‹ä¸€ä¸ªæ ‡è®°çš„ä¿¡æ¯ã€‚ä½ å¯ä»¥ä»è¿™ä¸ªå˜é‡è·å–å½“å‰æ ‡è®°çš„ä¿¡æ¯ï¼Œç„¶åè°ƒç”¨ä¸€æ¬¡ scan() ï¼Œå†é‡æ–°ä»è¿™ä¸ªå˜é‡è·å–ä¸‹ä¸€ä¸ªæ ‡è®°çš„ä¿¡æ¯ï¼ˆå½“ç„¶è¿™æ—¶å€™ä¸èƒ½å†è¯»å–ä¹‹å‰çš„æ ‡è®°ä¿¡æ¯äº†ï¼‰ã€‚

Scanner ç±»æä¾›äº†ä»¥ä¸Šæ‰€è¯´çš„æ‰€æœ‰åŠŸèƒ½ï¼š

```typescript
function scan(): SyntaxKind {
    startPos = pos; // è®°å½•æ‰«æä¹‹å‰çš„ä½ç½®
    while (true) {
        // è¿™æ˜¯ä¸€ä¸ªå¤§å¾ªç¯
        // å¦‚æœå‘ç°ç©ºæ ¼ã€æ³¨é‡Šï¼Œä¼šé‡æ–°å¾ªç¯ï¼ˆæ­¤æ—¶é‡æ–°è®¾ç½® tokenPosï¼Œå³è®© tokenPos å¿½ç•¥äº†ç©ºæ ¼ï¼‰
        // å¦‚æœå‘ç°ä¸€ä¸ªæ ‡è®°ï¼Œåˆ™é€€å‡ºå‡½æ•°
        tokenPos = pos;
        // åˆ°å­—ç¬¦ä¸²æœ«å°¾ï¼Œè¿”å›ç»“æŸæ ‡è®°
        if (pos >= end) {
            return token = SyntaxKind.EndOfFileToken;
        }
        // è·å–å½“å‰å­—ç¬¦çš„ç¼–ç 
        let ch = codePointAt(text, pos);

        switch (ch) {
            // æ¥ä¸‹æ¥å°±å¼€å§‹åˆ¤æ–­ä¸åŒçš„å­—ç¬¦å¯èƒ½å¹¶ç»„è£…æ ‡è®°
            case CharacterCodes.exclamation: // æ„Ÿå¹å·(!)
                if (text.charCodeAt(pos + 1) === CharacterCodes.equals) { // åé¢æ˜¯ä¸æ˜¯â€œ=â€
                    if (text.charCodeAt(pos + 2) === CharacterCodes.equals) { // åé¢æ˜¯ä¸æ˜¯è¿˜æ˜¯â€œ=â€
                        return pos += 3, token = SyntaxKind.ExclamationEqualsEqualsToken; // è·å¾—â€œ!==â€æ ‡è®°
                    }
                    return pos += 2, token = SyntaxKind.ExclamationEqualsToken; // è·å¾—â€œ!=â€æ ‡è®°
                }
                pos++;
                return token = SyntaxKind.ExclamationToken; //è·å¾—â€œ!â€æ ‡è®°
            case CharacterCodes.doubleQuote:
            case CharacterCodes.singleQuote:
                // ...(ç•¥)
        }
    }
}
```

æ‰«æçš„æ­¥éª¤å¾ˆç®€å•ï¼šå…ˆåˆ¤æ–­æ˜¯ä»€ä¹ˆå­—ç¬¦ï¼Œç„¶åå°è¯•ç»„æˆæ ‡è®°ã€‚

- ! -> != -> !==

é‡æ–°æ‰«æï¼šæ­£åˆ™åˆ¤æ–­

é¢„è§ˆæ ‡è®°ï¼šå…³é”®å­—å…¼å®¹

æ‰«æå™¨è®©å­—ç¬¦è¢«ç»„æˆ`token`ï¼Œå¯ä»¥è¿›å…¥ä¸‹ä¸€æ­¥éƒ¨çš„è¯­æ³•åˆ†æï¼Œä½¿ç”¨`token`ç»„æˆè¯­æ³•æ ‘ã€‚
