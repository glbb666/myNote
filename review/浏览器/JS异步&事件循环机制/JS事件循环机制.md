# èƒŒæ™¯

æ ¹æ®æµè§ˆå™¨æ¶æ„ï¼Œæˆ‘ä»¬çŸ¥é“ï¼Œåœ¨æ¸²æŸ“è¿›ç¨‹ä¸­

- ä¸»çº¿ç¨‹ï¼šè¿è¡ŒJavaScripå’Œé¡µé¢çš„æ¸²æŸ“ï¼ˆå¸ƒå±€å’Œç»˜åˆ¶ï¼‰æ˜¯äº’æ–¥çš„ï¼Œè¿™é‡Œä¼šç”¨åˆ°äº‹ä»¶å¾ªç¯æœºåˆ¶è¿›è¡Œè°ƒåº¦ã€‚
- äº‹ä»¶å¤„ç†çº¿ç¨‹ï¼šç›‘å¬å„ç§äº‹ä»¶ï¼ˆå¦‚ç”¨æˆ·è¾“å…¥ã€å®šæ—¶å™¨ã€ç½‘ç»œè¯·æ±‚ç­‰ï¼‰ï¼Œå¹¶æ ¹æ®äº‹ä»¶ç±»å‹å°†å›è°ƒå‡½æ•°æ”¾å…¥åˆé€‚çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼ˆå®ä»»åŠ¡é˜Ÿåˆ—æˆ–å¾®ä»»åŠ¡é˜Ÿåˆ—ï¼‰
- å®šæ—¶å™¨è§¦å‘çº¿ç¨‹ï¼š
  - `setInterval`å’Œ `setTimeout`æ‰€åœ¨çº¿ç¨‹ï¼Œå¯¹å®šæ—¶å™¨è®¡æ—¶å¹¶è§¦å‘å®šæ—¶ï¼Œè®¡æ—¶å®Œæ¯•ï¼Œä¼šè¢«äº‹ä»¶å¤„ç†çº¿ç¨‹æ·»åŠ åˆ°ä»»åŠ¡é˜Ÿåˆ—çš„é˜Ÿå°¾ã€‚
  - ä¸ºä»€ä¹ˆè¦å•ç‹¬çš„å®šæ—¶å™¨çº¿ç¨‹ï¼Ÿå› ä¸ºJavaScriptå¼•æ“æ˜¯å•çº¿ç¨‹çš„, å¦‚æœå¤„äºé˜»å¡çº¿ç¨‹çŠ¶æ€å°±ä¼šå½±å“è®°è®¡æ—¶çš„å‡†ç¡®ï¼Œå› æ­¤å¾ˆæœ‰å¿…è¦å•ç‹¬å¼€ä¸€ä¸ªçº¿ç¨‹ç”¨æ¥è®¡æ—¶ã€‚

## ä»»åŠ¡é˜Ÿåˆ—

`JS`åˆ†ä¸ºåŒæ­¥ä»»åŠ¡å’Œå¼‚æ­¥ä»»åŠ¡ã€‚

### åŒæ­¥ä»»åŠ¡

éƒ½åœ¨ä¸»çº¿ç¨‹ä¸Šæ‰§è¡Œï¼Œå½¢æˆä¸€ä¸ª**æ‰§è¡Œæ ˆã€‚**

### å¼‚æ­¥ä»»åŠ¡

å¼‚æ­¥ä»»åŠ¡åŒ…å«å®ä»»åŠ¡é˜Ÿåˆ—å’Œå¾®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç°åœ¨æˆ‘ä»¬å°†ä»–ä»¬å¯¹æ¯”

#### ä»»åŠ¡ç®¡ç†ï¼š

å®ä»»åŠ¡é˜Ÿåˆ—ç”±äº‹ä»¶è§¦å‘çº¿ç¨‹ç®¡ç†ã€‚å¾®ä»»åŠ¡é˜Ÿåˆ—ç”± `JS`å¼•æ“ç®¡ç†ã€‚

åœ¨æ–°çš„æµè§ˆå™¨ä¸­ï¼Œâ€œJavaScriptå¼•æ“â€æŒ‡çš„æ˜¯æµè§ˆå™¨å†…éƒ¨è´Ÿè´£è§£æå’Œæ‰§è¡ŒJavaScriptä»£ç çš„ç»„ä»¶ï¼Œå®ƒæ˜¯æµè§ˆå™¨åŠŸèƒ½çš„ä¸€éƒ¨åˆ†ï¼Œåœ¨æµè§ˆå™¨çš„ä¸»çº¿ç¨‹ä¸Šè¿è¡Œã€‚

#### ä»»åŠ¡é˜Ÿåˆ—æ•°é‡ï¼š

å®ä»»åŠ¡é˜Ÿåˆ—å¯ä»¥æœ‰å¤šä¸ªï¼Œè¿™äº›é˜Ÿåˆ—å¯ä»¥åŒ…å«ä¸åŒç±»å‹çš„ä»»åŠ¡ã€‚ä¾‹å¦‚å®šæ—¶å™¨ï¼ˆç”± `setTimeout`, `setInterval` æ·»åŠ çš„ä»»åŠ¡ï¼‰ã€I/Oæ“ä½œä»»åŠ¡ã€`UI`æ¸²æŸ“ä»»åŠ¡ç­‰ã€‚

å¾®ä»»åŠ¡é˜Ÿåˆ—é€šå¸¸åªæœ‰ä¸€ä¸ªï¼Œåœ¨ES6è§„èŒƒä¸­ï¼Œåªå®šä¹‰äº†ä¸€ä¸ªå¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚è¯¥é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡åŒ…æ‹¬ `Promise`çš„å›è°ƒç­‰ã€‚

#### åŒ…å«å“ªäº›ä»»åŠ¡

å®ä»»åŠ¡åŒ…å« `script(æ•´ä½“ä»£ç )`ã€`setTimeout`ã€`setInterval`ã€`I/O`ã€`UIäº¤äº’äº‹ä»¶`ã€`postMessage`ã€`MessageChannel`ã€`setImmediate(Node.js ç¯å¢ƒ)`

`microtask`ä¸»è¦åŒ…å«ï¼š`Promise.then`ã€`MutaionObserver`ã€`process.nextTick`(`Node.js` ç¯å¢ƒ)

## ä»»åŠ¡çš„æ‰§è¡Œé¡ºåº ï¼š

äº‹ä»¶å¾ªç¯æœºåˆ¶å°±æ˜¯å®ä»»åŠ¡æ‰§è¡Œå’Œå¾®ä»»åŠ¡é˜Ÿåˆ—æ¸…ç©ºï¼Œæ¥ç€uiæ¸²æŸ“çš„ä¸€ä¸ªå¾ªç¯ã€‚

ä¸»çº¿ç¨‹ä¼šååŒå…¶ä»–çš„çº¿ç¨‹æˆ–è€…è¿›ç¨‹å¯¹ä»»åŠ¡è¿›è¡Œå¤„ç†ã€‚

- æ ¹æ®æµè§ˆå™¨çš„ä¼˜å…ˆçº§ï¼Œä¸»çº¿ç¨‹ä»å®ä»»åŠ¡é˜Ÿåˆ—ä¸­å–ä¸€ä¸ªå®ä»»åŠ¡ï¼Œæ‰§è¡Œå®ä»»åŠ¡çš„åŒæ­¥ä»£ç ï¼Œå½“ç¢°åˆ°å¼‚æ­¥ä»»åŠ¡å°±äº¤ç»™åˆ«çš„è¿›ç¨‹æˆ–è€…çº¿ç¨‹å»æ‰§è¡Œï¼Œæ¯”å¦‚ç¢°åˆ°å®šæ—¶å™¨ä»»åŠ¡å°±äº¤ç»™å®šæ—¶å™¨çº¿ç¨‹ï¼Œç¢°åˆ°ç½‘ç»œè¯·æ±‚å°±äº¤ç»™ç½‘ç»œè¿›ç¨‹ã€‚ç­‰åˆ«çš„çº¿ç¨‹æˆ–è€…è¿›ç¨‹æ‰§è¡Œå®Œæ¯•ï¼Œå†æŠŠå“åº”è¿”å›ç»™æ¸²æŸ“è¿›ç¨‹çš„ä¸»çº¿ç¨‹ã€‚ä¸»çº¿ç¨‹ä¼šæ ¹æ®ä»»åŠ¡çš„ç±»å‹æŠŠ**ä»»åŠ¡çš„å›è°ƒäº‹ä»¶æ ¹æ®ä»»åŠ¡æºè¿›è¡Œåˆ†ç±»**ï¼Œå¡åˆ°ç›¸åº”çš„å®ä»»åŠ¡é˜Ÿåˆ—æˆ–æ˜¯å¾®ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚
- å½“å®ä»»åŠ¡å®Œæˆåï¼Œä¸»çº¿ç¨‹ä¼šå…ˆæ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—çš„æ‰€æœ‰å›è°ƒï¼Œå¦‚æœå¾®ä»»åŠ¡åœ¨æ­¤æœŸé—´äº§ç”Ÿäº†å…¶ä»–çš„å¾®ä»»åŠ¡ï¼Œä¹Ÿä¼šè¢«ä¸€å¹¶æ¸…ç©ºã€‚
- æ¥ç€è¿›è¡Œä¸€æ¬¡æ¸²æŸ“ï¼ˆä¸ä¸€å®šå‘ç”Ÿï¼ŒæŒ‰éœ€ï¼‰ã€‚
- ç„¶åå†æ ¹æ®æµè§ˆå™¨çš„è°ƒåº¦æœºåˆ¶ï¼Œä»æŸä¸€ä¸ªå®ä»»åŠ¡é˜Ÿåˆ—å–ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œï¼Œå¾ªç¯å¾€å¤ã€‚

å¯¹äºnodeè€Œè¨€ï¼Œå¾®ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºä¼šæœ‰ä¸€äº›å·®åˆ«

ä¸€ä¸ªæ˜¯å¾®ä»»åŠ¡é˜Ÿåˆ—æ•°é‡çš„åŒºåˆ«ã€‚

nodeå¤„ç†å¾®ä»»åŠ¡æœ‰ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯ `nextTickQueue`ï¼Œä¸€ä¸ªæ˜¯å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚

- å½“å‰å®ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œé¦–å…ˆä¼šæ£€æŸ¥ `nextTickQueue`ï¼Œæ‰§è¡Œå…¶ä¸­çš„å¾®ä»»åŠ¡ï¼ˆ`process.nextTick` æ‰€æ³¨å†Œçš„å›è°ƒï¼‰ã€‚æ— è®ºè¿™äº›å›è°ƒæ˜¯å¦åˆæ·»åŠ äº†æ›´å¤šçš„ `process.nextTick` å¾®ä»»åŠ¡ï¼ŒNode.js ä¼šæŒç»­æ‰§è¡Œ `nextTickQueue` ç›´åˆ°é˜Ÿåˆ—è¢«æ¸…ç©ºã€‚
- Node.js ä¼šå¤„ç†å…¶ä»–çš„å¾®ä»»åŠ¡ã€‚è¿™ä¸€ç¯èŠ‚åŒ…æ‹¬ `microtaskQueue`ï¼Œå…¶ä¸­åŒ…å«äº† `Promise` çš„å›è°ƒå’Œå…¶ä»–å¾®ä»»åŠ¡APIã€‚å°±åƒåœ¨æµè§ˆå™¨ä¸­ä¸€æ ·ï¼Œå¦‚æœåœ¨æ‰§è¡Œè¿™äº›å¾®ä»»åŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œåˆäº§ç”Ÿäº†æ–°çš„å¾®ä»»åŠ¡ï¼ŒNode.js ä¼šç»§ç»­æ‰§è¡Œï¼Œç›´åˆ° `microtaskQueue` ä¹Ÿè¢«æ¸…ç©ºã€‚
- process.nextTickå¦‚æœäº§ç”Ÿäº†å¾®ä»»åŠ¡ï¼Œå¯ä»¥åœ¨æœ¬é˜¶æ®µè¢«æ‰§è¡Œï¼Œå› ä¸ºé¡ºåºæ˜¯å…ˆæ¸…ç©º `nextTickQueue`åæ¸…ç©ºå…¶ä»–å¾®ä»»åŠ¡ï¼Œä½†æ˜¯microtaskQueueäº§ç”Ÿçš„process.nextTickå›è°ƒåˆ™ä¼šåœ¨ä¸‹ä¸ªä»»åŠ¡é˜¶æ®µæ‰§è¡Œã€‚

ä¸€ä¸ªæ˜¯æ‰§è¡Œæ—¶æœºçš„åŒºåˆ«ã€‚

 `Node`ç«¯ï¼Œå¾®ä»»åŠ¡åœ¨äº‹ä»¶å¾ªç¯çš„å„ä¸ªé˜¶æ®µä¹‹é—´æ‰§è¡Œã€‚

Node.js çš„äº‹ä»¶å¾ªç¯åŒ…å«å‡ ä¸ªä¸åŒçš„é˜¶æ®µï¼Œæ¯ä¸ªé˜¶æ®µè´Ÿè´£ç‰¹å®šç±»å‹çš„ä»»åŠ¡æˆ–æ“ä½œï¼Œè¿™äº›é˜¶æ®µçš„é¡ºåºå’ŒåŠŸèƒ½åœ¨ Node.js çš„ä¸åŒç‰ˆæœ¬ä¸­ä¿æŒä¸€è‡´ã€‚åœ¨è¿™äº›é˜¶æ®µä¹‹é—´ï¼ŒNode.js æ€»ä¼šä¼˜å…ˆæ‰§è¡Œå®Œæ‰€æœ‰çš„å¾®ä»»åŠ¡ï¼Œç„¶åå†ç»§ç»­è¿›å…¥ä¸‹ä¸€ä¸ªé˜¶æ®µçš„å®ä»»åŠ¡ã€‚

è¿™æ˜¯ Node.js äº‹ä»¶å¾ªç¯çš„å¤§è‡´å·¥ä½œæ–¹å¼ï¼š

1. **timers** é˜¶æ®µæ‰§è¡Œ `setTimeout()` å’Œ `setInterval()` çš„å›è°ƒã€‚
2. **I/O callbacks** é˜¶æ®µä¸»è¦å¤„ç†ç³»ç»Ÿæ“ä½œçš„å›è°ƒã€‚
3. **poll** é˜¶æ®µä¸»è¦æ˜¯è´Ÿè´£å¤„ç†å¤§å¤šæ•°çš„ I/O å›è°ƒï¼ŒåŒ…æ‹¬ç½‘ç»œã€æ–‡ä»¶ç­‰ï¼Œå¹¶ä¸”åœ¨ I/O äº‹ä»¶å‘ç”Ÿåï¼Œæ‰§è¡Œç›¸åº”çš„å›è°ƒå‡½æ•°ã€‚
4. **check** é˜¶æ®µç”¨äºå¤„ç† `setImmediate()` çš„å›è°ƒã€‚
5. **close callbacks** é˜¶æ®µä¸»è¦ç”¨äºå¤„ç†è¯¸å¦‚ `socket.on('close', ...)` è¿™æ ·çš„å…³é—­äº‹ä»¶çš„å›è°ƒã€‚

### QA

Qï¼šæ ˆä¸æ˜¯å…ˆè¿›åå‡ºå—ï¼Œä½†æ˜¯åŒæ­¥ä»»åŠ¡åº”è¯¥æ˜¯å…ˆæ¨å…¥çš„å…ˆæ‰§è¡Œï¼Œä¸ºä»€ä¹ˆå«æ‰§è¡Œæ ˆå‘¢

Aï¼šå› ä¸ºæ ˆå…³æ³¨çš„æ˜¯**å‡½æ•°è°ƒç”¨çš„é¡ºåº**ã€‚

å‡è®¾æˆ‘ä»¬æœ‰è¿™æ ·çš„ä»£ç ï¼š

```js
function first() {
    second();
    // æ›´å¤šä»£ç 
}

function second() {
}

first();

```

æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š

1. `first` å‡½æ•°è¢«è°ƒç”¨ï¼Œ`first` çš„æ‰§è¡Œä¸Šä¸‹æ–‡è¢«æ¨å…¥æ‰§è¡Œæ ˆã€‚
2. åœ¨ `first` å‡½æ•°ä¸­ï¼Œ`second` è¢«è°ƒç”¨ï¼Œ`second` çš„æ‰§è¡Œä¸Šä¸‹æ–‡è¢«æ¨å…¥æ ˆé¡¶ã€‚
3. `second` å‡½æ•°æ‰§è¡Œå®Œæ¯•ï¼Œå…¶ä¸Šä¸‹æ–‡ä»æ ˆä¸­å¼¹å‡ºï¼Œè¿”å›åˆ°äº† `first` é‡Œé¢ `second`çš„è°ƒç”¨ä¹‹åç»§ç»­æ‰§è¡Œã€‚
4. æœ€åæ˜¯ `first`å‡½æ•°æ‰§è¡Œå®Œæ¯•å¹¶ä»æ ˆé¡¶å¼¹å‡ºï¼Œè¿™æ—¶æ ˆä¸ºç©ºã€‚

æ‰€ä»¥ï¼Œå°½ç®¡å‡½æ•°æ˜¯æŒ‰ç…§å®ƒä»¬è¢«å†™å…¥ä»£ç çš„é¡ºåºä¸€ä¸€è°ƒç”¨çš„ï¼Œä½†æ‰§è¡Œæ ˆç¡®å®æ˜¯ä»¥â€œåè¿›å…ˆå‡ºâ€çš„æ–¹å¼æ“ä½œçš„ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆè¿™ä¹ˆç§°å‘¼çš„åŸå› ã€‚å½“æåŠ JavaScript çš„â€œæ‰§è¡Œæ ˆâ€ï¼Œæˆ‘ä»¬æ›´å…³æ³¨çš„æ˜¯å‡½æ•°è°ƒç”¨çš„é¡ºåºä»¥åŠå®ƒä»¬å¦‚ä½•åœ¨å†…å­˜ä¸­è¢«ç®¡ç†ã€‚

## `setTimeout`å’Œ `setInterval`çš„åŒºåˆ«

- `setTimeout` æ˜¯åœ¨è®¡æ—¶ç»“æŸåå°†å›è°ƒå‡½æ•°æ¨å…¥å®ä»»åŠ¡é˜Ÿåˆ—ï¼Œç­‰å¾…æ‰§è¡Œã€‚å¦‚æœå‰ä¸€ä¸ª `setTimeout` çš„å›è°ƒå‡½æ•°æ‰§è¡Œæ—¶é—´è¾ƒé•¿ï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ª `setTimeout` çš„è°ƒç”¨å¯èƒ½ä¼šå»¶è¿Ÿï¼Œä»è€Œå¯¼è‡´ç´¯ç§¯è¯¯å·®ã€‚
- è€Œ `setInterval` åˆ™ä¸è€ƒè™‘å›è°ƒå‡½æ•°çš„æ‰§è¡Œæ—¶é—´ï¼Œå®ƒä¼šæŒ‰ç…§è®¾å®šçš„æ—¶é—´é—´éš”æŒç»­æ¨å…¥æ–°çš„å›è°ƒå‡½æ•°åˆ°äº‹ä»¶é˜Ÿåˆ—ä¸­ã€‚ä½†å¦‚æœäº‹ä»¶é˜Ÿåˆ—ä¸­å·²ç»æœ‰å¾…æ‰§è¡Œçš„ `setInterval` çš„å›è°ƒï¼Œå®ƒä¸ä¼šå†æ¨å…¥æ–°çš„å›è°ƒã€‚è¿™æœ‰å¯èƒ½å¯¼è‡´é—´éš”æ—¶é—´çŸ­äºé¢„æœŸï¼Œå› ä¸ºä¸¤ä¸ªå›è°ƒä¹‹é—´å¯èƒ½æ²¡æœ‰è¶³å¤Ÿçš„æ—¶é—´é—´éš”ã€‚

ğŸŒŸæ³¨æ„ï¼š`W3C`åœ¨ `HTML`æ ‡å‡†ä¸­è§„å®šï¼Œ`setTimeout` å’Œ `setInterval` ç”¨äº 4ms ä»¥ä¸‹çš„å»¶è¿Ÿæ—¶ï¼Œå®é™…å°†ä½¿ç”¨ 4ms ä½œä¸ºå»¶è¿Ÿæ—¶é—´ã€‚

## `Promise`å’Œ `async`ä¸­çš„ç«‹å³æ‰§è¡Œ

æˆ‘ä»¬çŸ¥é“ `Promise`ä¸­çš„å¼‚æ­¥ä½“ç°åœ¨ `then`å’Œ `catch`ä¸­ï¼Œæ‰€ä»¥ `Promise`ä¸­çš„ä»£ç æ˜¯ç«‹å³æ‰§è¡Œçš„ã€‚è€Œåœ¨ `async/await`ä¸­ï¼Œåœ¨å‡ºç°*`await`å‡ºç°ä¹‹å‰ï¼Œå…¶ä¸­çš„ä»£ç ä¹Ÿæ˜¯ç«‹å³æ‰§è¡Œçš„ã€‚é‚£ä¹ˆå‡ºç°äº† `await`æ—¶å€™å‘ç”Ÿäº†ä»€ä¹ˆå‘¢ï¼Ÿ

## `await`åšäº†ä»€ä¹ˆ

ä»å­—é¢æ„æ€ä¸Šçœ‹ `await`å°±æ˜¯ç­‰å¾…ï¼Œ`await` ç­‰å¾…çš„æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œè¿™ä¸ªè¡¨è¾¾å¼çš„è¿”å›å€¼å¯ä»¥æ˜¯ä¸€ä¸ª `promise`å¯¹è±¡ä¹Ÿå¯ä»¥æ˜¯å…¶ä»–å€¼ã€‚


ç”±äºå› ä¸º `async await` æ˜¯ `generator`çš„è¯­æ³•ç³–ã€‚æ‰€ä»¥ `await`åé¢çš„ä»£ç æ˜¯å¾®ä»»åŠ¡ã€‚æ‰€ä»¥å¯¹äºæœ¬é¢˜ä¸­çš„

```javascript
async function async1() {
	console.log('async1 start');
	await async2();
	console.log('async1 end');
}
```

ç­‰ä»·äº

```javascript
async function async1() {
	console.log('async1 start');
	Promise.resolve(async2()).then(() =>{
                console.log('async1 end');
    })
}
```

## å›åˆ°æœ¬é¢˜

```javascript
//è¯·å†™å‡ºè¾“å‡ºå†…å®¹
async function async1() {
    console.log('async1 start');
    await async2();// awaitåé¢çš„è¡¨è¾¾å¼ä¼šå…ˆæ‰§è¡Œä¸€éï¼Œå°†awaitåé¢çš„ä»£ç åŠ å…¥åˆ°microtaskä¸­
    console.log('async1 end');
}
async function async2() {
	console.log('async2');
}

console.log('script start'); 

setTimeout(function() {
    console.log('setTimeout');
}, 0)

async1();

new Promise(function(resolve) {
    console.log('promise1');
}).then(function() {
    console.log('promise2');
});
console.log('script end');

/*
script start
async1 start
async2
promise1
script end
async1 end
promise2
setTimeout
*/
```

è¿™é“é¢˜ä¸»è¦è€ƒå¯Ÿçš„æ˜¯äº‹ä»¶å¾ªç¯ä¸­å‡½æ•°æ‰§è¡Œé¡ºåºçš„é—®é¢˜ï¼Œå…¶ä¸­åŒ…æ‹¬ `async` ï¼Œ`await`ï¼Œ`setTimeout`ï¼Œ`Promise`å‡½æ•°ã€‚ä¸‹é¢æ¥è¯´ä¸€ä¸‹æœ¬é¢˜ä¸­æ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹ã€‚

ä»¥ä¸Šå°±æœ¬é“é¢˜æ¶‰åŠåˆ°çš„æ‰€æœ‰ç›¸å…³çŸ¥è¯†ç‚¹äº†ï¼Œä¸‹é¢æˆ‘ä»¬å†å›åˆ°è¿™é“é¢˜æ¥ä¸€æ­¥ä¸€æ­¥çœ‹çœ‹æ€ä¹ˆå›äº‹å„¿ã€‚

1. é¦–å…ˆï¼Œäº‹ä»¶å¾ªç¯ä»å®ä»»åŠ¡é˜Ÿåˆ—å¼€å§‹ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå®ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œåªæœ‰ä¸€ä¸ªscript(æ•´ä½“ä»£ç )ä»»åŠ¡ï¼›å½“é‡åˆ°ä»»åŠ¡æº(task source)æ—¶ï¼Œåˆ™ä¼šå…ˆåˆ†å‘ä»»åŠ¡åˆ°å¯¹åº”çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­å»ã€‚æ‰€ä»¥ï¼Œä¸Šé¢ä¾‹å­çš„ç¬¬ä¸€æ­¥æ‰§è¡Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

   [![img](images/68747470733a2f2f692e6c6f6c692e6e65742f323031392f30322f30382f356335643639623432316166332e706e67.png)](https://camo.githubusercontent.com/15b3ae9733b0b5b6a144f519396ff88eaeca40fb/68747470733a2f2f692e6c6f6c692e6e65742f323031392f30322f30382f356335643639623432316166332e706e67)
2. ç„¶åæˆ‘ä»¬çœ‹åˆ°é¦–å…ˆå®šä¹‰äº†ä¸¤ä¸ª `async`å‡½æ•°ï¼Œæ¥ç€å¾€ä¸‹çœ‹ï¼Œç„¶åé‡åˆ°äº† `console` è¯­å¥ï¼Œç›´æ¥è¾“å‡º `script start`ã€‚è¾“å‡ºä¹‹åï¼Œscript ä»»åŠ¡ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œé‡åˆ° `setTimeout`ï¼Œå…¶ä½œä¸ºä¸€ä¸ªå®ä»»åŠ¡æºï¼Œåˆ™ä¼šå…ˆå°†å…¶ä»»åŠ¡åˆ†å‘åˆ°å¯¹åº”çš„é˜Ÿåˆ—ä¸­ï¼š
   [![img](images/68747470733a2f2f692e6c6f6c692e6e65742f323031392f30322f30382f356335643639623432353530612e706e67.png)](https://camo.githubusercontent.com/0a6e6cd2cc52d18a0f97ec01659058e830305a45/68747470733a2f2f692e6c6f6c692e6e65742f323031392f30322f30382f356335643639623432353530612e706e67)
3. `script` ä»»åŠ¡ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œæ‰§è¡Œäº† `async1()`å‡½æ•°ï¼Œå‰é¢è®²è¿‡ `async`å‡½æ•°ä¸­åœ¨ `await`ä¹‹å‰çš„ä»£ç æ˜¯ç«‹å³æ‰§è¡Œçš„ï¼Œæ‰€ä»¥ä¼šç«‹å³è¾“å‡º `async1 start`ã€‚
   é‡åˆ°äº† `await`æ—¶ï¼Œä¼šå°† `await`åé¢çš„è¡¨è¾¾å¼æ‰§è¡Œä¸€éï¼Œæ‰€ä»¥å°±ç´§æ¥ç€è¾“å‡º `async2`ï¼Œç„¶åå°†awaitåé¢çš„ä»£ç ä¹Ÿå°±æ˜¯ `console.log('async1 end')`åŠ å…¥åˆ° `microtask`ä¸­çš„ `Promise`é˜Ÿåˆ—ä¸­ï¼Œæ¥ç€è·³å‡º `async1`å‡½æ•°æ¥æ‰§è¡Œåé¢çš„ä»£ç ã€‚

[![img](images/68747470733a2f2f692e6c6f6c692e6e65742f323031392f30322f31382f356336616435383333376165642e706e67.png)](https://camo.githubusercontent.com/93ec5469b0846f0f161641fc718005dbe994d190/68747470733a2f2f692e6c6f6c692e6e65742f323031392f30322f31382f356336616435383333376165642e706e67)

4. `script`ä»»åŠ¡ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œé‡åˆ° `Promise`å®ä¾‹ã€‚ç”±äº `Promise`ä¸­çš„å‡½æ•°æ˜¯ç«‹å³æ‰§è¡Œçš„ï¼Œè€Œåç»­çš„ `.then` åˆ™ä¼šè¢«åˆ†å‘åˆ° `microtask` çš„ `Promise` é˜Ÿåˆ—ä¸­å»ã€‚æ‰€ä»¥ä¼šå…ˆè¾“å‡º `promise1`ï¼Œç„¶åæ‰§è¡Œ `resolve`ï¼Œå°† `promise2` åˆ†é…åˆ°å¯¹åº”é˜Ÿåˆ—ã€‚
   [![img](images/68747470733a2f2f692e6c6f6c692e6e65742f323031392f30322f31382f356336616435383334376135652e706e67.png)](https://camo.githubusercontent.com/6f617a237607ce7a71fabcab61d2952a8b412205/68747470733a2f2f692e6c6f6c692e6e65742f323031392f30322f31382f356336616435383334376135652e706e67)
5. `script`ä»»åŠ¡ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œæœ€ååªæœ‰ä¸€å¥è¾“å‡ºäº† `script end`ï¼Œè‡³æ­¤ï¼Œå…¨å±€ä»»åŠ¡å°±æ‰§è¡Œå®Œæ¯•äº†ã€‚
   æ ¹æ®ä¸Šè¿°ï¼Œæ¯æ¬¡æ‰§è¡Œå®Œä¸€ä¸ªå®ä»»åŠ¡ä¹‹åï¼Œä¼šå»æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¾®ä»»åŠ¡ï¼›å¦‚æœæœ‰ï¼Œåˆ™æ‰§è¡Œå¾®ä»»åŠ¡ç›´è‡³æ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚
   å› è€Œåœ¨ `script`ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œå¼€å§‹æŸ¥æ‰¾æ¸…ç©ºå¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚æ­¤æ—¶ï¼Œå¾®ä»»åŠ¡ä¸­ï¼Œ `Promise` é˜Ÿåˆ—æœ‰çš„ä¸¤ä¸ªä»»åŠ¡ `async1 end`å’Œ `promise2`ï¼Œå› æ­¤æŒ‰å…ˆåé¡ºåºè¾“å‡º `async1 endï¼Œpromise2`ã€‚å½“æ‰€æœ‰çš„å¾®ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œè¡¨ç¤ºç¬¬ä¸€è½®çš„å¾ªç¯å°±ç»“æŸäº†ã€‚
6. ç¬¬äºŒè½®å¾ªç¯å¼€å§‹ï¼Œè¿™ä¸ªæ—¶å€™å°±ä¼šè·³å› `async1`å‡½æ•°ä¸­æ‰§è¡Œåé¢çš„ä»£ç ï¼Œç„¶åé‡åˆ°äº†åŒæ­¥ä»»åŠ¡ `console` è¯­å¥ï¼Œç›´æ¥è¾“å‡º `async1 end`ã€‚è¿™æ ·ç¬¬äºŒè½®çš„å¾ªç¯å°±ç»“æŸäº†ã€‚ï¼ˆä¹Ÿå¯ä»¥ç†è§£ä¸ºè¢«åŠ å…¥åˆ° `script`ä»»åŠ¡é˜Ÿåˆ—ä¸­ï¼Œæ‰€ä»¥ä¼šå…ˆä¸ `setTimeout`é˜Ÿåˆ—æ‰§è¡Œï¼‰
7. ç¬¬äºŒè½®å¾ªç¯ä¾æ—§ä»å®ä»»åŠ¡é˜Ÿåˆ—å¼€å§‹ã€‚æ­¤æ—¶å®ä»»åŠ¡ä¸­åªæœ‰ä¸€ä¸ª `setTimeout`ï¼Œå–å‡ºç›´æ¥è¾“å‡ºå³å¯ï¼Œè‡³æ­¤æ•´ä¸ªæµç¨‹ç»“æŸã€‚

ä¸‹é¢æˆ‘ä¼šæ”¹å˜ä¸€ä¸‹ä»£ç æ¥åŠ æ·±å°è±¡ã€‚

## å˜å¼ä¸€

åœ¨ç¬¬ä¸€ä¸ªå˜å¼ä¸­æˆ‘å°† `async2`ä¸­çš„å‡½æ•°ä¹Ÿå˜æˆäº† `Promise`å‡½æ•°ï¼Œä»£ç å¦‚ä¸‹ï¼š

```javascript
async function async1() {
    console.log('async1 start');
    await async2();
    console.log('async1 end');
}
async function async2() {
    new Promise(function(resolve) {
        console.log('promise1');
        resolve();
    }).then(function() {
        console.log('promise2');
    });
}
console.log('script start');
setTimeout(function() {
    console.log('setTimeout');
}, 0)
async1();

new Promise(function(resolve) {
    console.log('promise3');
    resolve();
}).then(function() {
    console.log('promise4');
});

console.log('script end');
```

å¯ä»¥å…ˆè‡ªå·±çœ‹çœ‹è¾“å‡ºé¡ºåºä¼šæ˜¯ä»€ä¹ˆï¼Œä¸‹é¢æ¥å…¬å¸ƒç»“æœï¼š

```
script start
async1 start
promise1
promise3
script end
promise2
async1 end
promise4
setTimeout
```

## å˜å¼äºŒ

åœ¨ç¬¬äºŒä¸ªå˜å¼ä¸­ï¼Œæˆ‘å°†async1ä¸­awaitåé¢çš„ä»£ç å’Œasync2çš„ä»£ç éƒ½æ”¹ä¸ºå¼‚æ­¥çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š

```javascript
async function async1() {
    console.log('async1 start');
    await async2();
    //æ›´æ”¹å¦‚ä¸‹ï¼š 
    setTimeout(function() {
        console.log('setTimeout1')
    },0)
}
async function async2() {
    //æ›´æ”¹å¦‚ä¸‹ï¼š
	setTimeout(function() {
		console.log('setTimeout2')
	},0)
}
console.log('script start');

setTimeout(function() {
    console.log('setTimeout3');
}, 0)
async1();

new Promise(function(resolve) {
    console.log('promise1');
    resolve();
}).then(function() {
    console.log('promise2');
});
console.log('script end');
```

å¯ä»¥å…ˆè‡ªå·±çœ‹çœ‹è¾“å‡ºé¡ºåºä¼šæ˜¯ä»€ä¹ˆï¼Œä¸‹é¢æ¥å…¬å¸ƒç»“æœï¼š

```
script start
async1 start
promise1
script end
promise2
setTimeout3
setTimeout2
setTimeout1
```

## å˜å¼ä¸‰

å˜å¼ä¸‰æ˜¯æˆ‘åœ¨ä¸€ç¯‡é¢ç»ä¸­çœ‹åˆ°çš„åŸé¢˜ï¼Œæ•´ä½“æ¥è¯´å¤§åŒå°å¼‚ï¼Œä»£ç å¦‚ä¸‹ï¼š

```javascript
async function a1 () {
    console.log('a1 start')
    await a2()
    console.log('a1 end')
}
async function a2 () {
    console.log('a2')
}

console.log('script start')

setTimeout(() =>{
    console.log('setTimeout')
}, 0)

Promise.resolve().then(() =>{
    console.log('promise1')
})

a1()

let promise2 = new Promise((resolve) =>{
    resolve('promise2.then')
    console.log('promise2')
})

promise2.then((res) =>{
    console.log(res)
    Promise.resolve().then(() =>{
        console.log('promise3')
    })
})
console.log('script end')
```

æ— éæ˜¯åœ¨å¾®ä»»åŠ¡é‚£å—å„¿åšç‚¹æ–‡ç« ï¼Œå‰é¢çš„å†…å®¹å¦‚æœä½ éƒ½çœ‹æ‡‚äº†çš„è¯è¿™é“é¢˜ä¸€å®šæ²¡é—®é¢˜çš„ï¼Œç»“æœå¦‚ä¸‹ï¼š

```
script start
a1 start
a2
promise2
script end
promise1
a1 end
promise2.then
promise3
setTimeout
```

### æ€»ç»“

äº‹ä»¶å¾ªç¯æœºåˆ¶è¦ç‚¹ï¼š

- å®ä»»åŠ¡ï¼š`script`ã€`setTimeout`ã€`setTimeInterval`ã€`I/O`ã€`postMessage`ã€`setImmediate(node)`
- å¾®ä»»åŠ¡ï¼š`promise.then`ã€`process.nextTick`ã€`await`åé¢çš„ä»£ç 
- `promise`å’Œ `async`åçš„è¡¨è¾¾å¼ç«‹å³æ‰§è¡Œ
- `await`æœºåˆ¶ï¼šè®©å‡ºçº¿ç¨‹ï¼Œæ‰§è¡Œå…³é”®å­—åé¢çš„è¡¨è¾¾å¼ï¼Œè€Œ `await`åé¢çš„ä»£ç åŠ å…¥å¾®ä»»åŠ¡é˜Ÿåˆ—ã€‚

### å‚è€ƒæ–‡çŒ®

[https://github.com/Advanced-Frontend/Daily-Interview-Question/issues/7](https://github.com/Advanced-Frontend/Daily-Interview-Question/issues/7)

[ä»æµè§ˆå™¨å¤šè¿›ç¨‹åˆ°JSå•çº¿ç¨‹ï¼ŒJSè¿è¡Œæœºåˆ¶æœ€å…¨é¢çš„ä¸€æ¬¡æ¢³ç†](https://juejin.im/post/5a6547d0f265da3e283a1df7#heading-8)
