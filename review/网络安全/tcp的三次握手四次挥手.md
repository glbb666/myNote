[根据动画来学TCP的三次握手，四次挥手（简单了解）](<https://juejin.im/post/5b29d2c4e51d4558b80b1d8c#heading-0>)

[TCP的三次握手四次挥手（报文格式）](<https://juejin.im/post/5a0444d45188255ea95b66bc>)

[输入url之后（为什么三次握手四次挥手，2msl）](<https://juejin.im/post/5cc573c85188252e741ccbb6>)

## TCP报文格式

![img](https://user-gold-cdn.xitu.io/2017/11/9/156658d59583ec0274d5e1f9a23ac2e9?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

上图中有几个字段需要重点介绍下：

（1）源端口：占16位，2字节，表示发送方的端口号。源IP地址和源端口同时使用，能够标识发送方的应用进程，便于报文返回。

（2）目的端口：占16位，2字节，表示接收方的端口号。目的IP和目的端口同时使用，能够用来标识接收方的应用进程。

（3）序号Seq：占32位，用来标识从TCP源端向目的端发送的字节流，发起方发送数据时对此进行标记。

（5）确认号Ack：占32位，只有ACK标志位为1时，确认序号字段才有效，**Ack=Seq+1**。

（6）标志位：共6个，即URG、ACK、PSH、RST、SYN、FIN等，具体含义如下：

（A）URG：紧急指针（urgent pointer）有效。

（B）ACK：确认序号有效。

（C）PSH：接收方应该尽快将这个报文交给应用层。

（D）RST：重置连接。

（E）SYN：发起一个新连接。

（F）FIN：释放一个连接。

#### 需要注意的是：

（A）不要将确认序号Ack与标志位中的ACK搞混了。
（B）确认方Ack=发起方Req+1，两端配对。

## TCP 三次握手

![img](https://user-gold-cdn.xitu.io/2017/11/9/d8bf92c7906718271fdb8b0d2d5fe5b4?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)****

- 第一次握手
  - SYN = 1， 序列号(seq)= m
  - 客户端向服务端发送序列号(seq)置为m的SYN宝，向服务器请求建立连接。请求发送后，客户端便进入` SYN-SE NT` 主动半打开状态。
- 第二次握手
  - SYN = 1，ACK = 1，确认号 = m+1, seq(server) = n
  - 服务端收到SYN包后，如果同意建立连接，则会发送一个ACK/SYN包，发送完成后服务器进入 SYN-RECEIVED 状态
- 第三次握手 
  - ACK = 1，确认号 = n+1, seq(client) = z
  - 客户端收到连接同意的应答后，还要向服务端发送一个确认报文。客户端发完这个报文段后便进入ESTABLISHED 状态，服务端收到这个应答后也进入 ESTABLISHED 状态，此时连接建立成功。

## TCP 四次挥手

![img](images/8c7874fafe233c9278509e40e906055c)

- 第一次挥手
  - 若客户端认为数据发送完成，则它需要向服务端发送`FIN`包，请求释放连接，客户端进入`fin_wait_1`状态
- 第二次挥手
  - 服务器收到连接释放请求后，会告诉应用层要释放客户端到服务器的连接，但是因为 **TCP 连接是双向的**，所以服务器依然可以给客户端发送数据，服务器给客户端发送 ACK 包，并进入 **CLOSE_WAIT** 状态。
- 第三次挥手
  - 服务器如果此时**还有没发完的数据会继续发送**，完毕后会向客户端发送`FIN`包，请求释放连接，然后服务器便进入**LAST-ACK**状态。
- 第四次挥手
  - 客户端收到释放请求后，向服务器发送确认应答，此时客户端进入 **TIME-WAIT** 状态。该状态会持续 **2MSL**（最大段生存期，指报文段在网络中生存的时间，超时会被抛弃） 时间，若该时间段内没有服务器的重发请求的话，就进入**CLOSED**状态。当客户端收到确认应答后，也便进入 **CLOSED** 状态。

### 关于time_wait为什么是2个MSL

> MSL:最长报文段寿命

- 保证客户端发送的最后一个ACK报文能够到达服务器，因为这个ACK报文可能丢失，如果服务器没收到客户端的ACK报文，会觉得客户端没有收到它发送的请求断开报文，于是服务器又会重新发送一次。而客户端就能在这个2MSL时间段内收到这个重传的报文，接着给出回应报文，**并且会重启2MSL计时器**。

- 防止**已经失效的请求报文**出现在本连接中。客户端发送完最后一个确认报文后，在这个2MSL时间中，就可以使**本连接持续的时间内所产生的所有报文段都从网络中消失**。这样新的连接中不会出现旧连接的请求报文。

## 为什么建立连接是三次握手，而关闭连接却是四次挥手呢？
##### 三次握手（为什么不是两次握手呢？）

为了**防止失效的连接请求报文段突然又传送到服务器**，建立起新的连接，服务器会一直等待客户端发数据，导致服务器资源的浪费。

##### 四次挥手

关闭连接时，当服务端收到客户端的**FIN**报文时，仅仅表示客户端不再发送数据了但是还能接收数据，**服务端方也未必全部数据都发送给对方了，所以服务端可以立即close，也可以发送一些数据给对方后，再发送FIN报文给对方来表示同意现在关闭连接**，因此，己方ACK和FIN一般都会分开发送。

